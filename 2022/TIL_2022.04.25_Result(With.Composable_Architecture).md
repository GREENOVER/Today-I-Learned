## TIL (Today I Learned)

### 4ì›” 25ì¼ (ì›”)   

- #### [í•™ìŠµë‚´ìš©]    
  ### Result (With. Composable Architecture)           
  
  #### Result??    
  ìš°ì„  ì„ ì–¸ë¶€ëŠ” ì´ë ‡ìŠµë‹ˆë‹¤.   
  ```swift
  @frozen enum Result<Success, Failure> where Failure : Error
  ```
  ì¼ë°˜ì ì¸ ì—´ê±°í˜•ì´ë©° ê° ê²½ìš°ì— ì—°ê²°ëœ ê°’ì„ í¬í•¨í•´ ì„±ê³µ í˜¹ì€ ì‹¤íŒ¨ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì—´ê±°í˜• íƒ€ì…ì…ë‹ˆë‹¤!   

  #### Resultì˜ í•„ìš”ì„±?   

  ìš°ë¦¬ëŠ” ì´ë¯¸ do, catch, try, throwsì™€ ê°™ì€ ì—ëŸ¬ ì²˜ë¦¬ì— ëŒ€í•œ ë¬¸ë²•ì„ ì•Œê³  ìˆë‹¤ê³  ê°€ì •í•©ì‹œë‹¤!   
  í•´ë‹¹ ë¬¸ë²•ë“¤ë¡œ ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆì§€ë§Œ ëª¨ë“  ê²½ìš°ì—ì„œ ë‹¤ ì²˜ë¦¬í•˜ê¸°ì— ì–´ë µê³  ë³µì¡í•©ë‹ˆë‹¤.   
  ì´ëŸ¬í•œ ì¹œêµ¬ë“¤ì€ ì—ëŸ¬ì˜ ë™ê¸°ì ì¸ ì²˜ë¦¬ë¥¼ í•˜ëŠ”ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.   
  ë‹¤ë§Œ ìš°ë¦¬ëŠ” í†µì‹ ê³¼ ê°™ì€ ìƒí™©ì—ì„œ ì—ëŸ¬ë¥¼ ë¹„ë™ê¸° ì²˜ë¦¬í•´ì•¼í•  ë•Œë„ ë§ìŠµë‹ˆë‹¤.   
  ìš”ëŸ´ë•Œ Resultë¥¼ í™œìš©í•˜ë©´ ê¹”ë”í•˜ê³  í¸í•˜ê²Œ ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ğŸ‘   

  ê°ì´ ì˜ ì•ˆì˜¤ì‹¤ ìˆ˜ ìˆìœ¼ë‹ˆ ì´ì œ Resultì˜ ì‚¬ìš©ì„ ë³´ì‹œì£ !   

  #### Result ì‚¬ìš©   

  ì˜ˆë¥¼ ë“¤ê¸° ìœ„í•´ ì¹´ì¹´ì˜¤SDKë¥¼ í™œìš©í•´ ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ì¸ì„ í•œë‹¤ëŠ” ê°€ì •í•˜ì— ì½”ë“œë¡œ ì˜ˆì‹œë¥¼ ë“¤ê² ìŠµë‹ˆë‹¤!   
  ```swift
  func loginWithKakaoTalk(completion: @escaping (Result<[String: String], Error>) -> Void) {
    UserApi.shared.loginWithKakaoTalk { token, error in
      if let error = error {
        completion(.failure(error))
      }
      UserApi.shared.me { user, error in
        if let error = error {
          completion(.failure(error))
        }
        if let user = user {
          let nickName = user.kakaoAccount?.profile?.nickname ?? ""
          let email = user.kakaoAccount?.email ?? ""
          completion(.success(["nickName": nickName, "email": email]))
        }
      }
    }
  }
  ```
  ì í•´ë‹¹ ì½”ë“œë¥¼ ë³´ì‹œì£ !   
  ìš°ì„  ê°„ë‹¨íˆ ì„¤ëª…ë“œë¦¬ë©´ ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ì¸ì„ í•˜ë ¤ê³ í•˜ëŠ” ë©”ì„œë“œì…ë‹ˆë‹¤.   
  í•´ë‹¹ ë©”ì„œë“œì˜ íƒˆì¶œ í´ë¡œì €ë¡œ completionì´ë¼ê³  ì§€ì¹­í–ˆìœ¼ë©° Result íƒ€ì…ì„ ë°›ëŠ”ê±¸ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!   
  ê·¸ëŸ¼ 2ë²ˆì§¸ ë¼ì¸ì„ ë³´ì‹œì£ !  
  ì¹´ì¹´ì˜¤í†¡ì´ ì„¤ì¹˜ë˜ì–´ ìˆì„ê²½ìš° í•´ë‹¹ ë¼ì¸ì„ íƒ€ì„œ ë¡œê·¸ì¸ì„ ì‹œë„í•©ë‹ˆë‹¤.   
  tokenê³¼ errorë¥¼ ì¸ìë¡œ ë°›ì•„ ì—ëŸ¬ì´ë©´ ì»´í”Œë¦¬ì…˜ í•¸ë“¤ëŸ¬ì— Result íƒ€ì…ì¤‘ í•˜ë‚˜ì˜ ì¼€ì´ìŠ¤ì¸ failureë¥¼ errorë¥¼ ë‹´ì•„ ì‹¤í–‰í•´ì¤ë‹ˆë‹¤.   
  ë§Œì•½ ì—ëŸ¬ê°€ ì•„ë‹ˆë¼ë©´ ì­‰ ë„˜ì–´ê°‘ë‹ˆë‹¤.   
  Userì˜ ì •ë³´ë¥¼ ë°›ì•„ì™€ í´ë¡œì €ë¡œ userì™€ errorë¥¼ ê°€ì§€ê³  ë†‰ë‹ˆë‹¤.   
  ë§ˆì°¬ê°€ì§€ë¡œ ì—¬ê¸°ì„œë„ errorê°€ ë‚œë‹¤ë©´ ìœ„ì™€ ë™ì¼í•˜ê²Œ failureë¥¼ ë±‰ì–´ì¤ë‹ˆë‹¤.   
  ê·¸ë¦¬ê³  ì•„ë‹ˆë¼ë©´ ì›í•˜ëŠ” ë°ì´í„°ë¥¼ ë½‘ì•„ì˜¨ë’¤, ìµœì¢…ì ìœ¼ë¡œ Resultì˜ íƒ€ì… ì¤‘ ì„±ê³µì¸ successì—ë‹¤ ì •ì˜ëœ ë”•ì…”ë„ˆë¦¬ ê°’ì„ ë„£ì–´ì¤ë‹ˆë‹¤.   
  ì˜ ë³´ì‹œë©´ UserApi.xxx ë˜ëŠ” ë¶€ë¶„ë“¤ë„ ëª¨ë‘ íƒˆì¶œ í´ë¡œì €ë¡œ êµ¬í˜„ëœ ë¶€ë¶„ì—ì„œ ë†€ì•„ì¤€ê²ë‹ˆë‹¤.   
  ì¦‰ ë¹„ë™ê¸°ì  ì²˜ë¦¬ë¥¼ í•´ì•¼í•˜ëŠ” ë¶€ë¶„ì—ì„œ do catchê°™ì€ ë™ê¸°ì  ì—ëŸ¬ ì²˜ë¦¬ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ì •í™•í•œ ì˜ë„ëŒ€ë¡œ ë˜ì§€ ì•Šì„ê²ë‹ˆë‹¤.  
  ì´ ê²½ìš° Resultë¥¼ í™œìš©í•  ìˆ˜ ìˆê² ìŠµë‹ˆë‹¤!   

  #### Resultë¥¼ Composable Architectureì™€ ê°™ì´ ì‚¬ìš©í•´ë³´ê¸°   

  ìš°ì„  ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì„ í•˜ëŠ” ì„œë¹„ìŠ¤ ìì²´ë¥¼ ë§Œë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤.   
  í•´ë‹¹ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì„ ì„±ê³µí•˜ê²Œ ë˜ë©´ ìš” ì„œë¹„ìŠ¤ë¥¼ ë¶€ë¥¸ ì•¡ì…˜ì—ë‹¤ ê°’ì„ ì „ë‹¬í•´ ë‹¤ìŒ ì–´ë–¤ ì•¡ì…˜ì„ í˜¸ì¶œí• ì§€ ê·¸ëŸ° íë¦„ì„ êµ¬í˜„í•´ë³¼ê»˜ìš”!   

  <KakaoLoginService>   
  ```swift
  import Combine
  import KakaoSDKUser
  
  public class KakaoLoginService {
    public init() {}
  
    public func getKakaoUserInfo() -> AnyPublisher<[String: String], Error> {
      return Publishers.Create<[String: String], Error>(factory: { [unowned self] subscribers -> Cancellable in
        if UserApi.isKakaoTalkLoginAvailable() {
          self.loginWithKakaoTalk { result in
            switch result {
            case let .success(info):
              subscribers.send(info)
            case let .failure(error):
              subscribers.send(completion: .failure(error))
            }
            subscribers.send(completion: .finished)
          }
        } else {
          self.loginWithKakaoAccont { result in
            switch result {
            case let .success(info):
              subscribers.send(info)
            case let .failure(error):
              subscribers.send(completion: .failure(error))
            }
            subscribers.send(completion: .finished)
          }
        }
        return AnyCancellable({})
      })
      .eraseToAnyPublisher()
    }
  
    private func loginWithKakaoTalk(completion: @escaping (Result<[String: String], Error>) -> Void) {
      UserApi.shared.loginWithKakaoTalk { _, error in
        if let error = error {
          completion(.failure(error))
        }
        UserApi.shared.me { user, error in
          if let error = error {
            completion(.failure(error))
          }
          if let user = user {
            let nickName = user.kakaoAccount?.profile?.nickname ?? ""
            let email = user.kakaoAccount?.email ?? ""
            completion(.success(["nickName": nickName, "email": email]))
          }
        }
      }
    }
  
    private func loginWithKakaoAccont(completion: @escaping (Result<[String: String], Error>) -> Void) {
      UserApi.shared.loginWithKakaoAccount { _, error in
        if let error = error {
          completion(.failure(error))
        }
        UserApi.shared.me { user, error in
          if let error = error {
            completion(.failure(error))
          }
          if let user = user {
            let nickName = user.kakaoAccount?.profile?.nickname ?? ""
            let email = user.kakaoAccount?.email ?? ""
            completion(.success(["nickName": nickName, "email": email]))
          }
        }
      }
    }
  }
  ```
  ìš°ì„  ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì„œë¹„ìŠ¤ë¼ëŠ” ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì„ í•´ì¤„ ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” Environmentì˜ ê°ì²´ì…ë‹ˆë‹¤.   
  ìœ„ì—ì„œ loginWithKakaoTalk ë©”ì„œë“œë¥¼ ê²°êµ­ ì´ ì„œë¹„ìŠ¤ë¥¼ ë¶ˆëŸ¬ ì‚¬ìš©ë  getKakaoUserInfoë¼ëŠ” ë©”ì„œë“œì—ì„œ í˜¸ì¶œí•´ì¤ë‹ˆë‹¤.   
  ì˜ ë³´ë©´ loginWithKakaoTalkì˜ í´ë¡œì €ì— switch ë¶„ê¸°ë¥¼ íƒœì›Œ ì„±ê³µì¼ë•Œì™€ ì‹¤íŒ¨ì¼ë•Œë¡œ ë‚˜ëˆ  subscribersì— ê°ê¸° ë‹¤ë¥¸ íë¦„ì„ ì „ë‹¬í•´ì¤ë‹ˆë‹¤.   
  (combineì˜ ì½”ë“œë“¤ì€ ë³„ë„ë¡œ ì„¤ëª…í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤!)   
  ì •ë¦¬í•˜ìë©´ getKakaoUserInfoë¥¼ í˜¸ì¶œí•˜ë©´ ë‚´ë¶€ì—ì„œ ì¹´ì¹´ì˜¤í†¡ ì„¤ì¹˜/ë¯¸ì„¤ì¹˜ì— ë”°ë¼    loginWithKakaoTalk/loginWithKakaoAccount ë©”ì„œë“œë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.   
  í•´ë‹¹ ë©”ì„œë“œì—ì„œëŠ” íƒˆì¶œ í´ë¡œì €ë¡œ Resultíƒ€ì…ì„ ì‚¬ìš©í•˜ê³  ì—ëŸ¬ë¥¼ ì¡ì•„ì¤ë‹ˆë‹¤.   
  ê·¸ë¦¬ê³  getKakaoUserInfoì—ì„œ í•´ë‹¹ í´ë¡œì €ë¥¼ ë°›ì•„ì™€ ì ì ˆí•˜ê²Œ ë¶„ê¸°ë¥¼ íƒœì›Œ subscribersì—ê²Œ ê²°ê³¼ë¥¼ ì „ë‹¬í•˜ê³  ì¢…ë£Œì‹œí‚µë‹ˆë‹¤.   

  ì ê·¸ëŸ¼ ì´ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œ ì½”ì–´ ì•¡ì…˜ìœ¼ë¡œ ê°€ë³´ì‹œì£ !   

  <LoginCore>   
  ```swift
  let loginReducer = Reducer<WithSharedState<LoginState>, LoginAction, LoginEnvironment> {
    state, action, env in
    switch action {
    case .kakaoLoginButtonTapped:
      return env.kakaoLoginService.getKakaoUserInfo()
        .catchToEffect()
        .flatMapLatest({ result -> Effect<LoginAction, Never> in
          switch result {
          case .failure:
            return .none
          case let .success(userInfo):
            state.local.nickName =  userInfo["nickName", default: ""]
            state.local.email =  userInfo["email", default: ""]
            return .none
          }
        })
        .eraseToEffect()
    }
  }
  ```
  Coreì—ì„œ Reducer ë¶€ë¶„ë§Œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!    
  ë³´ì‹œë©´ kakaoLoginButtonì´ íƒ­ë˜ì—ˆì„ë•Œ ì¹´ì¹´ì˜¤ë¡œê·¸ì¸ì„œë¹„ìŠ¤ì— ì •ì˜ëœ getKakaoUserInfo ë©”ì„œë“œë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.   
  catchToEffect ì˜¤í¼ë ˆì´í„°ë¥¼ ì´ìš©í•´ ë°›ì•„ì˜¨ ë¦¬í„´ê°’ì„ Effect Resultíƒ€ì…ìœ¼ë¡œ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
  ê·¸ëŸ¬ë©´ ìš°ë¦¬ëŠ” í•´ë‹¹ ë¦¬í„´ê°’ì„ Resultì²˜ëŸ¼ ì—ëŸ¬ì™€ ë°ì´í„°ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.   
  ê·¸ë¦¬ê³  flatMapLatest ì˜¤í¼ë ˆì´í„°ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.   
  (í•´ë‹¹ ì˜¤í¼ë ˆì´í„°ëŠ” CombineExt ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ìˆëŠ”ê²ƒì…ë‹ˆë‹¤!)   
  ê²°êµ­ ìœ„ì—ì„œ ë°›ì•„ì˜¨ result ì¦‰ Result<[String : String], Error> ê°’ì„ ì´ìš©í•´ í•´ë‹¹ ìœ„ì¹˜í•œ Effect<LoginAction, Never> ì´í™íŠ¸ íƒ€ì…ìœ¼ë¡œ ë°˜í™˜ ì‹œì¼œì£¼ë ¤ëŠ” ê²ë‹ˆë‹¤.   
  í•´ë‹¹ resultê°’ì—ëŠ” ì„±ê³µê³¼ ì‹¤íŒ¨ê°€ ë“¤ì–´ìˆê² ì£ ?   
  ì‹¤íŒ¨ ì¼ë•Œ ì›í•˜ëŠ” ì•¡ì…˜ í˜¹ì€ ë‹¤ë¥¸ ë¡œì§ë“¤ì„ ë„£ì–´ì£¼ë©´ ë©ë‹ˆë‹¤.   
  ì„±ê³µì¼ë•Œ ì €ëŠ” ìš°ì„  stateì— ê°’ì„ ì €ì¥í•  ìˆ˜ ìˆë„ë¡ë§Œ í•´ë’€ëŠ”ë° í•„ìš”í•˜ë‹¤ë©´ ë‹¤ìŒ ì•¡ì…˜ì„ ë¦¬í„´ì‹œì¼œì¤˜ë„ ë©ë‹ˆë‹¤!   

  ì ê°„ë‹¨í•˜ì£ ..?   
  ê·¼ë° ì—¬ê¸°ì„œ catchToEffectë¼ëŠ” ì˜¤í¼ë ˆì´í„°ê°€ ë‚˜ì™”ì–´ìš”.   
  ì•„ì£¼ì•„ì£¼ ì ê¹ ì‚´í´ë³´ê³  ê°€ì‹œì£ !   

  #### catchToEffect?   

  Composable Architecture ì†ŒìŠ¤ ì½”ë“œì— ì •ì˜ëŠ” ì´ë ‡ìŠµë‹ˆë‹¤.   
  ```swift
  public func catchToEffect() -> Effect<Result<Output, Failure>, Never> {
    self.map(Result.success)
      .catch { Just(.failure($0)) }
      .eraseToEffect()
  }
  ```
  mapì„ í•´ì„œ Resultì˜ ì„±ê³µ íƒ€ì…ìœ¼ë¡œ ê±°ë¥´ë˜ failureëŠ” ìºì¹˜í•´ì„œ ì´í™íŠ¸ë¡œ ê°ì‹¼ë‹¤.   
  ë­ ì´ì •ë„ë¡œ ê°„ë‹¨íˆ í•´ì„í•  ìˆ˜ ìˆì„ê²ƒ ê°™ì•„ìš”.   
  ì¦‰ í•´ë‹¹ ë“¤ì–´ì˜¨ ì¹œêµ¬ë¥¼ Resultì˜ Effect íƒ€ì…ìœ¼ë¡œ ë§Œë“¤ì–´ ë°˜í™˜í•˜ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.   

  #### catchToEffect ì˜ˆì‹œ   
  ```swift
  case .buttonTapped:
    return environment.fetchUser(id: 1)
      .catchToEffect()
      .map(ProfileAction.userResponse)
  ```
  ê³µì‹ ì†ŒìŠ¤ì½”ë“œì—ëŠ” ì´ë ‡ê²Œ ë‚˜ì™€ìˆì–´ìš”.   
  í•´ì„í•´ë³´ì£ !   
  ìš°ì„  ìš°ë¦¬ëŠ” ìœ„ì—ì„œ ì„œë¹„ìŠ¤ë¼ ì¹­í•œê²ƒì´ ì—¬ê¸°ì„  environmentì˜ fetchUser ë©”ì„œë“œê°€ ë˜ê² ë„¤ìš”!   
  í•´ë‹¹ ë©”ì„œë“œì— id 1ì˜ ê°’ì„ ì£¼ê³  ëŒì•„ì˜¨ Effect íƒ€ì…ì˜ ë¬´ì–¸ê°€ë¥¼ Resultë¡œ ë°”ê¾¸ê¸°ìœ„í•´ catchToEffectë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.    
  ê·¸ë¦¬ê³  ê²°ê³¼ê°’ì„ ê°€ì§€ê³  ë‹¤ë¥¸ ì•¡ì…˜ìœ¼ë¡œ ë§¤í•‘í•´ì¤¬ë„¤ìš”!   
  ì´ë ‡ë“¯ ì •ë¦¬í•˜ìë©´ ë“¤ì–´ì˜¨ ê°’ì˜ ê²°ê³¼ê°’ Resultë¡œ ë§Œë“¤ì–´ ì„±ê³µê³¼ ì‹¤íŒ¨ë¡œ êµ¬ë¶„ì§€ì–´ ì‚¬ìš©í•˜ê³  ì‹¶ì„ë•Œ catchToEffect ì˜¤í¼ë ˆì´í„°ë¡œ ë³€í™˜í•´ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤!   

  #### ë§ˆë¬´ë¦¬   
  ì.. ì–´ì©Œë‹¤ë³´ë‹ˆ Resultì— ëŒ€í•œ í•™ìŠµë³´ë‹¤ ì•½ê°„ Composable Architectureì— ëŒ€í•œ ê³ ì°°ì´ ëœê²ƒ ê°™ê¸´í•©ë‹ˆë‹¤..?    
  ê·¸ë˜ë„ Resultë¥¼ ë”¥í•˜ê²ŒëŠ” ì•„ë‹ˆì§€ë§Œ ì•Œê³  ì§€ë‚˜ê°‘ë‹ˆë‹¤~   

  #### [ì°¸ê³ ìë£Œ]   
  https://green1229.tistory.com/239   
  https://developer.apple.com/documentation/swift/result   

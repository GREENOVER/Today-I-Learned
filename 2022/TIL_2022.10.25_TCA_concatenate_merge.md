## TIL (Today I Learned)

### 10ì›” 25ì¼ (í™”)    

- #### [í•™ìŠµë‚´ìš©] 
    ### TCA - concatenate & merge (ì—¬ëŸ¬ Effectë¥¼ ë‹¨ì¼ Effectë¡œ ë§Œë“¤ê¸°)

    #### concatenateì˜ ì •ì˜ ë° êµ¬í˜„
    ```swift
    extension EffectPublisher {
      @inlinable
      public static func concatenate(_ effects: Self...) -> Self {
        Self.concatenate(effects)
      }

      @inlinable
      public static func concatenate<C: Collection>(_ effects: C) -> Self where C.Element == Self {
        effects.reduce(.none) { $0.concatenate(with: $1) }
      }

      @inlinable
      @_disfavoredOverload
      public func concatenate(with other: Self) -> Self {
        switch (self.operation, other.operation) {
        case (_, .none):
          return self
        case (.none, _):
          return other
        case (.publisher, .publisher), (.run, .publisher), (.publisher, .run):
          return Self(
            operation: .publisher(
              Publishers.Concatenate(prefix: self, suffix: other).eraseToAnyPublisher()
            )
          )
        case let (.run(lhsPriority, lhsOperation), .run(rhsPriority, rhsOperation)):
          return Self(
            operation: .run { send in
              if let lhsPriority = lhsPriority {
                await Task(priority: lhsPriority) { await lhsOperation(send) }.cancellableValue
              } else {
                await lhsOperation(send)
              }
              if let rhsPriority = rhsPriority {
                await Task(priority: rhsPriority) { await rhsOperation(send) }.cancellableValue
              } else {
                await rhsOperation(send)
              }
            }
          )
        }
      }
    }
    ```
    concatenateëŠ” ì—¬ëŸ¬ Effectë¥¼ ë‹¨ì¼ Effectë¡œ ì—°ê²°í•´ ì‹¤í–‰í•´ì£¼ëŠ” ê¸°ëŠ¥ì„ í•©ë‹ˆë‹¤.
    ë‹¤ë§Œ ì—¬ê¸°ì„œ ì¤‘ìš”í•œê±´ ì—¬ëŸ¬ Effectë“¤ì„ ë³‘í•©í•´ í•˜ë‚˜ì˜ Effectë¡œ ë°©ì¶œí• ë•Œ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ì‹œí‚¤ë©´ì„œ í•©ì¹œë‹¤ëŠ” ì ì…ë‹ˆë‹¤.
    ë¨¼ì € ë“¤ì–´ì˜¨ Effectë¥¼ ì‹¤í–‰í•´ ì™„ë£Œ í˜¹ì€ ì·¨ì†Œ ëœ í›„ ì´í›„ Effectë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

    ê·¸ê±¸ ì—¼ë‘í•´ë‘ê³  ë” ë³´ì‹œì£ !
    ì •ì˜ê°€ ë¹„êµì  ì–´ë µì§„ ì•ŠìŠµë‹ˆë‹¤.

    ìš°ì„  ë‚´ë¶€ ë©”ì„œë“œì¸ concatenateë¥¼ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
    Selfíƒ€ì…ì€ ë‹¹ì—°íˆ Effectì¼ê²ƒì´ê³  í•´ë‹¹ Effectë¥¼ ë°›ì•„ ìˆœì„œë¥¼ ì²´í¬í•©ë‹ˆë‹¤.
    ë¨¼ì € ë“¤ì–´ì˜¨ Effectê°€ ì•„ë‹ˆë¼ë©´ ëŒ€ê¸°í•˜ê³  ìˆœì„œì— ë§ê²Œ ì²˜ë¦¬í•˜ëŠ” êµ¬ì„±ì…ë‹ˆë‹¤.

    ì´ ë‚´ë¶€ ë©”ì„œë“œë¥¼ ê°€ì§€ê³  ì—¬ëŸ¬ Effectë“¤ì„ ì‹¤ì œì ìœ¼ë¡œ ë°›ì•„ reduce í•¨ìˆ˜ë¡œ ë³‘í•©í•˜ëŠ” ê³¼ì •ì„ ê±°ì¹˜ë©´ì„œ ë‚´ë¶€ì—ì„œëŠ” í•´ë‹¹ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹¤í–‰í•´ì¤ë‹ˆë‹¤.

    ê²°ë¡ ì ìœ¼ë¡œëŠ” ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.
    ```swift
    return Effect.concatenate([
      Effect(value: .firstAction),
      Effect(value: .secondAction),
    ])
    ```
    ì¦‰ firstActionì„ ë¨¼ì € ì‹¤í–‰ì‹œí‚¤ê³  ëë‚œ í›„ ìˆœì°¨ì ìœ¼ë¡œ secondActionì„ ì‹¤í–‰ì‹œí‚µë‹ˆë‹¤.
    ë§Œì•½ ì•„ë˜ê°™ì´ ì‚¬ìš©í•˜ë©´ ìˆœì„œê°€ ë‹¬ë¼ì§‘ë‹ˆë‹¤.
    ```swift
    return Effect.concatenate([
      Effect(value: .secondAction),
      Effect(value: .firstAction),
    ])
    ```
    ì´ëŸ´ ê²½ìš° secondActionì„ ì‹¤í–‰ í›„ firstActionì„ ì‹¤í–‰ì‹œí‚¤ì£ .
    listì— ë„£ì–´ì£¼ëŠ” ìˆœì„œë¥¼ ê¼­ ìœ ì˜í•´ì•¼ í•©ë‹ˆë‹¤.

    ì£¼ë¡œ concatenateëŠ” ìˆœì„œë¥¼ ë³´ì¥í•´ì•¼í•˜ëŠ” êµ¬í˜„ë“¤ì— ì‚¬ìš©í•©ë‹ˆë‹¤.
    Actionì´ ì‹¤í–‰ë˜ë©´ ì–´ë–¤ effectë¥¼ ì·¨ì†Œí•˜ê³  ê·¸ ë‹¤ìŒ effectë¥¼ ì‹¤í–‰í•´ì•¼ í•œë‹¤ê±°ë‚˜,
    í† ìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ë¨¼ì € ë„ìš°ê³  ë’¤ë¡œ ë·°ë¥¼ ì´ë™ì‹œì¼œì•¼ í•œë‹¤ê±°ë‚˜ í• ë•Œ ì£¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

    ì•„ì£¼ ì‰½ì£ !? ê¸°ì–µí• ê±´ í•˜ë‚˜ì—ìš”! ìˆœ.ì„œ.ëŒ€.ë¡œğŸ™Œ

    ê·¸ëŸ¼ ì´ì–´ì„œ mergeì— ëŒ€í•´ ì•Œì•„ë³´ì£ !

    #### mergeì˜ ì •ì˜ ë° êµ¬í˜„
    ```swift
    extension EffectPublisher {
      @inlinable
      public static func merge(_ effects: Self...) -> Self {
        Self.merge(effects)
      }

      @inlinable
      public static func merge<S: Sequence>(_ effects: S) -> Self where S.Element == Self {
        effects.reduce(.none) { $0.merge(with: $1) }
      }

      @inlinable
      public func merge(with other: Self) -> Self {
        switch (self.operation, other.operation) {
        case (_, .none):
          return self
        case (.none, _):
          return other
        case (.publisher, .publisher), (.run, .publisher), (.publisher, .run):
          return Self(operation: .publisher(Publishers.Merge(self, other).eraseToAnyPublisher()))
        case let (.run(lhsPriority, lhsOperation), .run(rhsPriority, rhsOperation)):
          return Self(
            operation: .run { send in
              await withTaskGroup(of: Void.self) { group in
                group.addTask(priority: lhsPriority) {
                  await lhsOperation(send)
                }
                group.addTask(priority: rhsPriority) {
                  await rhsOperation(send)
                }
              }
            }
          )
        }
      }
    }
    ```
    mergeëŠ” concatenateì™€ ë‹¤ë¥´ê²Œ ìˆœì„œë¥¼ íƒ€ì§€ ì•ŠìŠµë‹ˆë‹¤.
    ì¦‰ ì—¬ëŸ¬ Effectë¥¼ ë‹¨ì¼ Effectë¡œ ë™ì‹œì— ë³‘í•©í•´ë²„ë¦½ë‹ˆë‹¤.
    ê·¸ëŸ¼ìœ¼ë¡œ ìˆœì°¨ì ìœ¼ë¡œ listì— ë„£ì–´ì¤¬ì–´ë„ ë™ì‹œì— ì‹¤í–‰í•˜ê¸°ì— ìˆœì„œë¥¼ Effectê°„ ìˆœì„œë¥¼ ë³´ì¥í•  ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤!

    ë‚´ë¶€ merge ë©”ì„œë“œ êµ¬í˜„ì„ ë³´ì‹œì£ .
    concatenateì™€ ê±°ì§„ í¼ì€ ìœ ì‚¬í•´ìš”.
    ë‹¤ë§Œ concatenateëŠ” lhs, rhsë¡œ ìˆœì„œë¥¼ êµ¬ë¶„í–ˆë‹¤í•˜ë©´ mergeëŠ” ë¹„ë™ê¸°ë¡œ ë“¤ì–´ì˜¨ Effectì— ëŒ€í•´ ë°”ë¡œ ì²˜ë¦¬í•´ë²„ë¦½ë‹ˆë‹¤.

    ì‚¬ìš©ë²•ì€ ì•„ë˜ì™€ ê°™ì•„ìš”.
    ```swift
    return Effect.merge([
      Effect(value: .firstAction),
      Effect(value: .secondAction),
    ])
    ```
    ìˆœì„œê°€ ë³´ì¥ë˜ì§€ ì•Šìœ¼ë‹ˆ firstì™€ second ì–´ë–¤ê²ƒì´ ë¨¼ì € ì‹¤í–‰ë˜ê³  ëë‚ ì§€ëŠ” ëª¨ë¦…ë‹ˆë‹¤.

    ì£¼ë¡œ ê´€ë ¨ ì—†ëŠ” ê°ê°ì˜ Stateë“¤ì„ ë³€ê²½í• ë•Œ ìˆœì„œì˜ ë³´ì¥ì´ë‚˜ ì„ í›„ ê´€ê³„ê°€ í•„ìš” ì—†ì„ë•Œ ì €ëŠ” ì£¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

    #### ë§ˆë¬´ë¦¬
    concatenateì™€ merge ì‚¬ìš© ì§„ì§œ ë§ì´ ì´ë¤„ì§€ë‹ˆê¹Œ ì•Œë©´ ì¢‹ìŠµë‹ˆë‹¤!
    ì•„ë‹ˆ ì•Œì•„ì•¼ë˜ëŠ”ê²ƒì¤‘ í•˜ë‚˜ì£ ..!
    ë¬¼ë¡  concatenateì™€ mergeë¥¼ í•œ Action Switchë¬¸ì—ì„œ ì¤‘ì²©í•´ì„œ ë‹¨ì¼ Effectë¡œë„ ë§Œë“¤ì–´ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.
    ììœ ë¡­ê²Œ ìˆœì„œì˜ ì˜í–¥ì„ ë°›ëŠ”ê²ƒì¸ì§€ íŒë‹¨í•˜ê³  ì‚¬ìš©í•˜ë©´ ì¢‹ìŠµë‹ˆë‹¤ğŸ•ºğŸ»

    #### [ì°¸ê³  ìë£Œ]
    https://green1229.tistory.com/292   
    https://github.com/pointfreeco/swift-composable-architecture/blob/main/Sources/ComposableArchitecture/Effect.swift#L367
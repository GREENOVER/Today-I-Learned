# [SE-0510] Introduce Dictionary.mapValuesWithKeys

ì•ˆë…•í•˜ì„¸ìš”. **ê·¸ë¦°**ì…ë‹ˆë‹¤ ğŸ

ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” **SE-0510 Introduce Dictionary.mapValuesWithKeys**ì— ëŒ€í•´ ì •ë¦¬í•´ë³´ê² ìŠµë‹ˆë‹¤ ğŸ™‹ğŸ»

![img](https://blog.kakaocdn.net/dna/EYWCM/dJMcahpTc2l/AAAAAAAAAAAAAAAAAAAAAPdPo82mJ4LQSpYY-Py1Z4UPajCCqU7mvQupoNvoJI3x/img.jpg?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1772290799&allow_ip=&allow_referer=&signature=JghbDermawRLEFpleza%2FRIf8KV8%3D)

------

## **Intro**

> Dictionaryì˜ ê°’ì„ ë³€í™˜í•  ë•Œ key ì •ë³´ë„ í•¨ê»˜ í•„ìš”í•œ ê²½ìš°ê°€ ì¢…ì¢… ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ í˜„ì¬ëŠ” ì´ëŸ° ì‘ì—…ì„ í•˜ë ¤ë©´ init(uniqueKeysWithValues:)ë‚˜ reduce(into:)ë¥¼ ì¨ì•¼ í•˜ëŠ”ë°, ì´ë“¤ì€ ë¶ˆí•„ìš”í•˜ê²Œ dictionaryë¥¼ rehashingí•˜ê±°ë‚˜ **ì¬í• ë‹¹í•˜ëŠ” ë¹„ìš©ì´ ë°œìƒí•©ë‹ˆë‹¤.**

SE-0510ì€ ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **mapValuesWithKeysë¼ëŠ” ìƒˆë¡œìš´ ë©”ì„œë“œë¥¼ ì œì•ˆ**í•©ë‹ˆë‹¤.

Key ì •ë³´ë¥¼ transformation closureì— ì „ë‹¬í•˜ë©´ì„œë„ ì„±ëŠ¥ ì˜¤ë²„í—¤ë“œ ì—†ì´ ê°’ë§Œ ë³€í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ ğŸš€

í˜„ì¬ ì‹œì ì—ì„œëŠ” ë¦¬ë·°ê°€ ë“œë˜í”„íŠ¸ ìƒíƒœì´ê³  ì§„í–‰ì¤‘ì´ì§€ë§Œ ê³§ ë°˜ì˜ë˜ì§€ ì•Šì„ê¹Œ ì‹¶ìŠµë‹ˆë‹¤.

------

## **ì™œ í•„ìš”í•œê°€?**

> Dictionary ê°’ì„ ë³€í™˜í•˜ë©´ì„œ keyë„ í•¨ê»˜ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²½ìš°, í˜„ì¬ëŠ” ì´ë ‡ê²Œ í•´ì•¼ í•©ë‹ˆë‹¤.

```swift
let new: [Key: NewValue] = .init(
    uniqueKeysWithValues: old.lazy.map { ($0, transform(id: $0, payload: $1)) }
)
// or
let new: [Key: NewValue] = old.reduce(into: [:]) {
    $0[$1.key] = transform(id: $1.key, payload: $1.value)
}
```

**ë‘ ë°©ë²• ëª¨ë‘ ì‹¬ê°í•˜ê²Œ ë¹„íš¨ìœ¨ì ì…ë‹ˆë‹¤.**

- ì²« ë²ˆì§¸ ë°©ë²•: ëª¨ë“  keyë¥¼ ë‹¤ì‹œ hashing
- ë‘ ë²ˆì§¸ ë°©ë²•: ì—¬ëŸ¬ ë²ˆì˜ ì¤‘ê°„ ì¬í• ë‹¹ ë°œìƒ

ë²¤ì¹˜ë§ˆí¬ë¥¼ ëŒë ¤ë³´ë©´ ì²« ë²ˆì§¸ê°€ ì¤‘ê°„ ì¬í• ë‹¹ì´ ì ì–´ì„œ ê·¸ë‚˜ë§ˆ ì¡°ê¸ˆ ëœ ë‚˜ìœ ì •ë„ì…ë‹ˆë‹¤.

Dictionary keyë¥¼ ë³€í™˜í•˜ëŠ” ì¼€ì´ìŠ¤ë„ ìˆì§€ë§Œ, **ì´ ì œì•ˆì€ keyëŠ” ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ì•Šê³  ì»¨í…ìŠ¤íŠ¸ë¡œë§Œ ì‚¬ìš©í•˜ëŠ” ì¼€ì´ìŠ¤ì— ì§‘ì¤‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.**

------

## **ì œì•ˆëœ ì†”ë£¨ì…˜**

> Dictionaryì— ìƒˆë¡œìš´ ë©”ì„œë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

```swift
extension Dictionary {
    @inlinable public func mapValuesWithKeys<T, E>(
        _ transform: (Key, Value) throws(E) -> T
    ) throws(E) -> Dictionary<Key, T>
}
```

> ì‚¬ìš© ì˜ˆì‹œ

```swift
let balances: [Currency: Int64] = [.USD: 13, .EUR: 15]
let displayText: [Currency: String] = balances.mapValuesWithKeys {
    "\($0.alpha3) balance: \($1)"
}
```

> ê°„ë‹¨í•˜ì£ ?
>  Key ì •ë³´ë¥¼ ì‚¬ìš©í•˜ë©´ì„œë„ rehashing ì—†ì´ ê¹”ë”í•˜ê²Œ ê°’ë§Œ ë³€í™˜í•©ë‹ˆë‹¤.

------

## **ìƒì„¸ ì„¤ê³„**

êµ¬í˜„ì€ ê¸°ì¡´ mapValuesì™€ ìœ ì‚¬í•˜ì§€ë§Œ, **storage iteration loop ë‚´ë¶€ì—ì„œ keyì™€ valueë¥¼ í•¨ê»˜ transformation closureì— ì „ë‹¬í•©ë‹ˆë‹¤.**

------

## **Apple í”Œë«í¼ í˜¸í™˜ì„±**

Apple í”Œë«í¼ì—ì„œ **DictionaryëŠ” Cocoa dictionaryë¡œ backingë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

í•˜ì§€ë§Œ í° ë¬¸ì œëŠ” ì—†ë‹¤ê³  ë§í•˜ê³  ìˆìŠµë‹ˆë‹¤.

__CocoaDictionaryì—ë„ _NativeDictionaryì™€ ë³¸ì§ˆì ìœ¼ë¡œ ë™ì¼í•œ ë©”ì»¤ë‹ˆì¦˜ì„ ì¶”ê°€í•˜ë©´ ë˜ê³ , ìƒˆë¡œìš´ mapValuesWithKeysê°€ ê¸°ì¡´ mapValuesì²˜ëŸ¼ ë‘ êµ¬í˜„ ì‚¬ì´ì—ì„œ dispatchí•˜ë©´ ë©ë‹ˆë‹¤.

------

## **ê³ ë ¤ëœ ëŒ€ì•ˆë“¤**

### **ê¸°ì¡´ mapValues ì˜¤ë²„ë¡œë”©?**

ì›ë˜ **ì´ˆì•ˆì—ì„œëŠ” ê¸°ì¡´ mapValues ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¡œë”©í•´ì„œ Keyì™€ Valueë¥¼ ëª¨ë‘ ë°›ëŠ” closureë¥¼ ì§€ì›í•˜ë ¤ê³  í–ˆìŠµë‹ˆë‹¤.**

í•˜ì§€ë§Œ **ì´ê²Œ source-breakingì¸ ê±¸ ë°œê²¬í–ˆì–´ìš”.**

> ë“œë¬¼ì§€ë§Œ value íƒ€ì…ì´ 2-tupleì¸ dictionaryì—ì„œ mapValuesë¥¼ í˜¸ì¶œí•˜ëŠ” ê²½ìš°ê°€ ìˆê±°ë“ ìš”.

```swift
let dict: [String: (Int, String)] = ["a": (1, "x")]
dict.mapValues { ... } // ëª¨í˜¸í•´ì§
```

> ê·¸ë˜ì„œ source compatibilityë¥¼ ìœ„í•´ ìƒˆë¡œìš´ ì´ë¦„ mapValuesWithKeysë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤.

------

### **compactMapValuesë„ ì¶”ê°€?**

**mapValuesWithKeysë¥¼ ì¶”ê°€í•˜ë©´ compactMapValuesì™€ API ë¹„ëŒ€ì¹­ì´ ìƒê¹ë‹ˆë‹¤.**

compactMapValuesëŠ” key contextë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë‹ˆê¹Œìš”.

í•˜ì§€ë§Œ compactMapValuesëŠ” ë³¸ì§ˆì ìœ¼ë¡œ reduce(into:)ì˜ shorthandë¼ì„œ ì„±ëŠ¥ ì¸¡ë©´ì˜ ë™ê¸°ê°€ í›¨ì”¬ ì•½í•˜ê±°ë“ ìš”.

------

### **ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šê¸°?**

DictionaryëŠ” extensively frozen typeì´ë¼ì„œ, ê°œë°œìê°€ user spaceì—ì„œ stable-but-unspecified implementation detailì— ì˜ì¡´í•´ì„œ key contextë¥¼ ì§€ì›í•˜ë„ë¡ retrofití•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ì´ê±´ ì¢‹ì€ ì›Œí¬í”Œë¡œìš°ê°€ ì•„ë‹ˆê³  ê¶Œì¥í•´ì„œë„ ì•ˆ ë©ë‹ˆë‹¤.

------

## **í–¥í›„ ë°©í–¥**

### **mapValues ì´ë¦„ ì¬í• ë‹¹?**

ë¯¸ë˜ì—ëŠ” **ê¸°ì¡´ mapValues ë©”ì„œë“œë¥¼ mapValuesWithoutKeys ê°™ì€ ì´ë¦„ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤**.

ê·¸ëŸ¬ë©´ mapValues ì´ë¦„ì„ key contextë¥¼ ì œê³µí•˜ëŠ” ë²„ì „ì— ì¬í• ë‹¹í•  ìˆ˜ ìˆê² ì£ .

ë‹¤ìŒ ì–¸ì–´ ëª¨ë“œì—ì„œ ê°€ëŠ¥í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

------

### **OrderedDictionary ë³€ê²½ (swift-collections)**

> ì´ ì œì•ˆì˜ ìì—°ìŠ¤ëŸ¬ìš´ í™•ì¥ìœ¼ë¡œ, swift-collections íŒ¨í‚¤ì§€ì˜ OrderedDictionary íƒ€ì…ë„ mapValuesWithKeys ë©”ì„œë“œë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
extension OrderedDictionary {
    @inlinable public func mapValuesWithKeys<T, E>(
        _ transform: (Key, Value) throws(E) -> T
    ) throws(E) -> OrderedDictionary<Key, T>
}
```

**OrderedDictionaryì˜ ì„±ëŠ¥ í–¥ìƒì€ Dictionaryë³´ë‹¤ ë” í´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

OrderedDictionaryëŠ” keysì™€ valuesë¥¼ ìœ„í•œ í‘œì¤€ Arrayì™€ lookupì„ ìœ„í•œ sidecar hash tableì„ ìœ ì§€í•˜ê±°ë“ ìš”.

í˜„ì¬ workaround(reduceë‚˜ init)ëŠ” ì „ì²´ hash tableì„ ì¬êµ¬ì„±í•˜ê³  keys arrayë¥¼ eager copyí•´ì•¼ í•©ë‹ˆë‹¤.

ëŒ€ì‹  zipped iterationì„ ì‚¬ìš©í•´ì„œ underlying _keysì™€ _values arrayë¥¼ ìƒˆë¡œìš´ values arrayë¡œ ë§¤í•‘í•˜ê³ , _keys table(hash table __storage í¬í•¨)ì„ ë³µì‚¬í•˜ë©´ ë©ë‹ˆë‹¤.

ì´ê±´ mutateí•˜ì§€ ì•Šìœ¼ë©´ O(1) copy-on-writeì´ê³ , ë‚˜ì¤‘ì— mutateí•˜ë©´ O(n)ì…ë‹ˆë‹¤.

------

## **Conclusion**

Dictionary ê°’ì„ ë³€í™˜í•˜ë©´ì„œ keyë„ ì‚¬ìš©í•˜ëŠ” ê±´ í”í•œ íŒ¨í„´ì¸ë°, ì§€ê¸ˆê¹Œì§€ëŠ” ë¶ˆí•„ìš”í•œ ì„±ëŠ¥ ë¹„ìš©ì„ ê°ìˆ˜í•´ì•¼ í–ˆëŠ”ë° ì´ëŸ° ë©”ì„œë“œê°€ ì œê³µë˜ë©´ ì¡°ê¸ˆ ë” í¸í•˜ê²Œ ì‚¬ìš©ë  ìˆ˜ ìˆì„ê²ƒ ê°™ë„¤ìš”.

íŠ¹íˆ Currency ê°™ì€ enumì„ keyë¡œ ì“°ë©´ì„œ display textë¥¼ ë§Œë“œëŠ” ì˜ˆì‹œì²˜ëŸ¼, keyê°€ formatting contextë¥¼ ì œê³µí•˜ëŠ” ê²½ìš°ê°€ ë§ì–ì•„ìš” ğŸ˜

ê°„ë‹¨í•œ ì¶”ê°€ì§€ë§Œ í˜„ì—…ì—ì„œ ë§ì´ ì“°ì¼ ê²ƒ ê°™ë„¤ìš” ğŸ˜ƒ

------

## **References**

[Giving Dictionary.mapValues(_:) access to the associated key](https://forums.swift.org/t/giving-dictionary-mapvalues-access-to-the-associated-key/83904)

[SE-0510: Dictionary mapValuesWithKeys](https://forums.swift.org/t/se-0510-dictionary-mapvalueswithkeys/84547)
## TIL (Today I Learned)

### 6ì›” 13ì¼ (í™”)    

- ### [í•™ìŠµë‚´ìš©] Model your schema with SwiftData (feat. WWDC 2023)   
    
    ### Utilizing schema macros

    ìŠ¤í‚¤ë§ˆ ë§¤í¬ë¡œë¥¼ ìµœëŒ€í•œ í™œìš©í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ë³¼ê¹Œìš”?
    ìŠ¤í‚¤ë§ˆ ë§¤í¬ë¡œë¥¼ í™œìš©í•˜ë©´ ì•±ì—ì„œ ì™„ë²½í•˜ê²Œ ì‘ë™í•˜ë„ë¡ ì§€ì†ì ì¸ í™˜ê²½ì˜ ë™ì‘ì„ ì»¤ìŠ¤í…€í•˜ê²Œ ì§€ì •í•  ìˆ˜ ìˆì–´ìš”.
    ```swift
    @Model
    final class Trip {
      var name: String
      var destination: String
      var start_date: Date
      var end_date: Date

      var bucketList: [BucketListItem]? = []
      var livingAccommodation: LivingAccommodation?
      ...
    }
    ```
    ê¸°ë³¸ì ìœ¼ë¡œ í•´ë‹¹í•˜ëŠ” ëª¨ë¸ì´ ìˆì„ë•Œ ì—¬ê¸°ì„œ ê° ì—¬í–‰ì˜ ì´ë¦„ ì¦‰, nameì´ ê³ ìœ í•œì§€ í™•ì¸í•˜ì§„ ì•ŠìŠµë‹ˆë‹¤.
    ë™ì¼í•œ ì´ë¦„ì˜ Trip ê°„ì—ëŠ” ì¶©ëŒì´ ë°œìƒí•˜ì£ .

    ì´ë¥¼ ìœ„í•´ @Attribute ìŠ¤í‚¤ë§ˆ ë§¤í¬ë¡œë¥¼ í™œìš©í•  ìˆ˜ ìˆì–´ìš”.

    #### @Attribute
    ```swift
    @Attribute(.unique) var name: String
    ```
    í•´ë‹¹ ìŠ¤í‚¤ë§ˆ ë§¤í¬ë¡œë¡œ ìœ ë‹ˆí¬ ì˜µì…˜ì„ ì‚¬ìš©í•´ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”.
    SwiftDataëŠ” ì˜êµ¬ì ì¸ ë°±ì—”ë“œì— ì €ì¥í•˜ëŠ” ëª¨ë“  Tripì´ ê³ ìœ í•œ ì´ë¦„ì„ ê°€ì§€ë„ë¡ ë³´ì¥í•˜ì—¬ ìƒì„±í•©ë‹ˆë‹¤.
    ë§Œì•½ í•´ë‹¹ ì´ë¦„ì˜ Tripì´ ì¡´ì¬í•˜ë©´ ë’·ë‹¨ì—ì„œ ìµœì‹  ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    ê·¸ê±¸ ë°”ë¡œ upsertë¼ê³  ë¶€ë¦…ë‹ˆë‹¤.
    upsertëŠ” insertë¡œ ë¶€í„° ì‹œì‘í•˜ì—¬ ê¸°ì¡´ ë°ì´í„°ì™€ ì¶©ëŒí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ì˜ ì†ì„±ì„ ì—…ë°ì´íŠ¸ í•©ë‹ˆë‹¤.
    ìˆ«ì, ë¬¸ìì—´, UUIDì™€ ê°™ì€ ê¸°ë³¸ ê°’ íƒ€ì…ì´ë‚˜ ì¼ëŒ€ì¼ ê´€ê³„ë¥¼ ë§ºì„ ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ì†ì„±ì— ëŒ€í•´ì„œë„ ìœ ë‹ˆí¬ ì œì•½ì„ ì„¤ì •í•  ìˆ˜ ìˆì£ .

    ê·¸ëŸ¼ ìœ„ì—ì„œ start/end_dateì— ì–¸ë”ë°”ë¥¼ ì—†ì• ê³  ì‹¶ìœ¼ë©´ ì–´ë–»ê²Œ í• ê¹Œìš”?
    ê¸°ì¡´ ëª¨ë¸ì€ ìœ ì§€í•œì±„ ê°€ì ¸ê°€ì•¼ í•œë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ í•´ì¤„ ìˆ˜ ìˆì–´ìš”.
    ```swift
    @Attribute(originalName: "start_date") var startDate: Date
    @Attribute(originalName: "end_date") var endDate: Date
    ```
    ì›ë˜ ë„¤ì´ë°ì—ì„œ ë§¤í•‘í•˜ë©´ ë°ì´í„° ì†ì‹¤ì„ ë°©ì§€í•  ìˆ˜ ìˆì£ .

    ì •ë¦¬í•´ë³´ë©´ @Attribute ë§¤í¬ë¡œëŠ” ëŒ€ìš©ëŸ‰ ë°ì´í„°ë¥¼ ì™¸ë¶€ì— ì €ì¥í•˜ê³  ë³€í™˜ ê°€ëŠ¥í•œ í•­ëª©ì„ ì§€ì›í•˜ëŠ” ë“± ë§ì€ ì‘ì—…ì„ í•´ì¤ë‹ˆë‹¤.

    ì´ì œ relationshipì— ëŒ€í•´ í•œë²ˆ ì‚´í´ë³¼ê»˜ìš”ğŸ•ºğŸ»

    #### @Relationship

    ìœ„ ì½”ë“œì—ì„œ ë²„í‚·ë¦¬ìŠ¤íŠ¸ì™€ ìˆ™ì†Œì— ëŒ€í•œ ì •ë³´ë„ í•´ë‹¹ Tripì´ ì‚¬ë¼ì§€ë©´ ì‚­ì œë˜ê¸¸ ì›í•  ìˆ˜ ìˆì£ .
    ê·¸ëŸ´ë•ŒëŠ” ì•„ë˜ ì½”ë“œì²˜ëŸ¼ ê´€ê³„ ë§¤í¬ë¡œë¥¼ ì´ìš©í•´ ë§ºì–´ì¤ë‹ˆë‹¤.
    ```swift
    @Relationship(.cascade)
    var bucketList: [BucketListItem]? = []

    @Relationship(.cascade)
    var livingAccommodation: LivingAccommodation?
    ```
    ì´ì   ì—¬í–‰ì„ ì‚­ì œí•˜ë©´ ì € ê´€ê³„ë“¤ì˜ ë°ì´í„°ë„ ì‚­ì œë˜ì£ !
    í•´ë‹¹ ë§¤í¬ë¡œëŠ” ìµœì†Œ ë° ìµœëŒ€ ê´€ê³„ ê°œìˆ˜ë¥¼ ì§€ì •í•˜ëŠ” ê¸°ëŠ¥ ë“± ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì´ ìˆìŠµë‹ˆë‹¤.

    ì ê·¸ëŸ¼ ëª¨ë¸ì—ì„œ ë§Œì•½ ì§€ì†ì ìœ¼ë¡œ ì €ì¥ë˜ëŠ” ì†ì„±ì´ ì•„ë‹Œ ê°’ì„ ë„£ê³  ì‹¶ë‹¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”?

    #### @Trasient
    ```swift
    @Transient
    var tripViews: Int = 0
    ```
    ë‹¨ìˆœí•˜ê²Œ @Transient ë§¤í¬ë¡œë¥¼ ì‚¬ìš©í•´ì£¼ë©´ í•´ë‹¹ í”„ë¡œí¼í‹°ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    ì¦‰, ë¶ˆí•„ìš”í•œ ë°ì´í„°ê°€ ì§€ì†ë˜ëŠ”ê²ƒì„ ë°©ì§€í•´ì¤ë‹ˆë‹¤.
    ë˜í•œ, ì„ì‹œ í”„ë¡œí¼í‹°ì— ëŒ€í•œ ê¸°ë³¸ê°’ì„ ì œê³µí•´ì¤ë‹ˆë‹¤.

    ì´ì´ì„œ ì¢€ ë” ìŠ¤í‚¤ë§ˆë¥¼ ë°œì „í•˜ëŠ” ë°©ë²•ì„ ì‚´í´ë³¼ê»˜ìš” ğŸ„ğŸ»â€â™‚ï¸

    ### Evolving schemas

    ì•±ì´ ë³€ê²½ë¨ì— ë”°ë¼ ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ í†µí•´ ìŠ¤í‚¤ë§ˆë¥¼ ë°œì „ì‹œí‚¤ëŠ” ë°©ë²•ì„ ë³´ê² ìŠµë‹ˆë‹¤.
    í”„ë¡œí¼í‹° ì¶”ê°€ ë° ì œê±°ì™€ ê°™ì´ ìŠ¤í‚¤ë§ˆë¥¼ ë³€ê²½í•˜ë©´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ë°œìƒí•©ë‹ˆë‹¤.
    SwiftDataë¥¼ ì‚¬ìš©í•˜ë©´ ì´ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì‰¬ì›Œì§‘ë‹ˆë‹¤ğŸ˜ƒ

    VersionedSchemaì™€ SchemaMigrationPlan

    ë‘ ê¸°ëŠ¥ì´ ê°€ëŠ¥í•˜ê²Œ í•´ì¤ë‹ˆë‹¤.

    1ï¸âƒ£ VersionedSchema

    SwiftData ëª¨ë¸ì„ ë³€ê²½í•˜ì—¬ ì•±ì˜ ìƒˆ ë²„ì „ì„ ì¶œì‹œí•  ë•Œë§ˆë‹¤ ì´ì „ì— ì¶œì‹œí•œ ìŠ¤í‚¤ë§ˆë¥¼ ìº¡ìŠí™”í•˜ëŠ” VersionedSchemaë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ì¦‰ ë²„ì „ë§ˆë‹¤ SwiftDataì˜ ë³€ê²½ ì‚¬í•­ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.

    2ï¸âƒ£ SchemaMigrationPlan

    VersionedSchemasë¥¼ ë”°ë¼ SchemaMigrationPlanì„ ìƒì„±í•©ë‹ˆë‹¤.

    ì´ ìˆœì„œë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    ë§ˆì´ê·¸ë ˆì´ì…˜ì—ë„ ë‘ê°€ì§€ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.

    1ï¸âƒ£ Lightweight

    ê²½ëŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ì—ëŠ” ë‹¤ìŒ ì•± ë¦´ë¦¬ì¦ˆë¥¼ ìœ„í•´ ê¸°ì¡´ ë°ì´í„°ë¥¼ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ê¸° ìœ„í•œ ì¶”ê°€ ì½”ë“œê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    ë‹¨ìˆœíˆ Dateì™€ ê°™ì€ í”„ë¡œí¼í‹°ì— originalNameì„ ì¶”ê°€í•˜ê±°ë‚˜ ê´€ê³„ì— ëŒ€í•œ ì‚­ì œ ê·œì¹™ì„ ì§€ì •í•˜ëŠ”ê²ƒê³¼ ê°™ì€ ìˆ˜ì •ë“¤ì€ ê²½ëŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.

    ê·¸ëŸ¬ë‚˜ Tripì˜ ì´ë¦„ì„ ê³ ìœ í•˜ê²Œ ë§Œë“œëŠ”ê²ƒê³¼ ê°™ì€ ë³€ê²½ì€ ê²½ëŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ì— ì í•©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    ì»¤ìŠ¤í…€ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ í•„ìš”í•´ìš”!

    2ï¸âƒ£ Custom

    ë³€ê²½ ì‚¬í•­ì— ëŒ€í•´ ì»¤ìŠ¤í…€í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¨ê³„ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
    ì¦‰, ì˜ˆë¥¼ë“¤ì–´ Tripì˜ ì´ë¦„ì´ ê³ ìœ í•´ì§€ê¸°ì „ì— ì¤‘ë³µì„ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    ê·¸ëŸ¼ ì»¤ìŠ¤í…€í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ì–´ë–»ê²Œ í•˜ëŠ” ê±¸ê¹Œìš”?

    #### Custom Migration

    ìš°ì„  VersionedSchemaë¥¼ ì§€ì •í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.
    ```swift
    enum SampleTripsSchemaV1: VersionedSchema {
        static var models: [any PersistentModel.Type] {
            [Trip.self, BucketListItem.self, LivingAccommodation.self]
        }

        @Model
        final class Trip {
            var name: String
            var destination: String
            var start_date: Date
            var end_date: Date

            var bucketList: [BucketListItem]? = []
            var livingAccommodation: LivingAccommodation?
        }

        // Define the other models in this version...
    }

    enum SampleTripsSchemaV2: VersionedSchema {
        static var models: [any PersistentModel.Type] {
            [Trip.self, BucketListItem.self, LivingAccommodation.self]
        }

        @Model
        final class Trip {
            @Attribute(.unique) var name: String
            var destination: String
            var start_date: Date
            var end_date: Date

            var bucketList: [BucketListItem]? = []
            var livingAccommodation: LivingAccommodation?
        }

        // Define the other models in this version...
    }

    enum SampleTripsSchemaV3: VersionedSchema {
        static var models: [any PersistentModel.Type] {
            [Trip.self, BucketListItem.self, LivingAccommodation.self]
        }

        @Model
        final class Trip {
            @Attribute(.unique) var name: String
            var destination: String
            @Attribute(originalName: "start_date") var startDate: Date
            @Attribute(originalName: "end_date") var endDate: Date

            var bucketList: [BucketListItem]? = []
            var livingAccommodation: LivingAccommodation?
        }

        // Define the other models in this version...
    }
    ```
    ì´ë ‡ê²Œ ë²„ì „ë§ˆë‹¤ ìŠ¤í‚¤ë§ˆ ëª¨ë¸ì„ ì„¤ì •í•´ë‘˜ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    ê·¸ ë‹¤ìŒìœ¼ë¡œ SchemaMigrationPlanì„ êµ¬ì„±í•´ ë¦´ë¦¬ì¦ˆê°„ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì„ ë‚˜íƒ€ë‚´ì•¼ í•©ë‹ˆë‹¤.
    ```swift
    enum SampleTripsMigrationPlan: SchemaMigrationPlan {
        static var schemas: [any VersionedSchema.Type] {
            [SampleTripsSchemaV1.self, SampleTripsSchemaV2.self, SampleTripsSchemaV3.self]
        }

        static var stages: [MigrationStage] {
            [migrateV1toV2, migrateV2toV3]
        }

        static let migrateV1toV2 = MigrationStage.custom(
            fromVersion: SampleTripsSchemaV1.self,
            toVersion: SampleTripsSchemaV2.self,
            willMigrate: { context in
                let trips = try? context.fetch(FetchDescriptor<SampleTripsSchemaV1.Trip>())

                // De-duplicate Trip instances here...

                try? context.save() 
            }, didMigrate: nil
        )

        static let migrateV2toV3 = MigrationStage.lightweight(
            fromVersion: SampleTripsSchemaV2.self,
            toVersion: SampleTripsSchemaV3.self
        )
    }
    ```
    ë§ˆì´ê·¸ë ˆì´ì…˜ì˜ ìˆœì„œ ì§€ì • í›„ ê²½ëŸ‰ í˜¹ì€ ì»¤ìŠ¤í…€ ë§ˆì´ê·¸ë ˆì´ì…˜ì¸ì§€ ì§€ì •í•´ì¤ë‹ˆë‹¤.
    ê·¸ë¦¬ê³  stagesì— ë‹´ëŠ”ê²ƒì´ì£ .
    ë³´ì‹œë©´ V1ì—ì„œ V2ê¹Œì§€ëŠ” ë°ì´í„°ê°€ ë§ˆì´ê·¸ë ˆì´ì…˜ ë˜ê¸° ì „ì— ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ì»¤ìŠ¤í…€í•œ êµ¬í˜„ì„ í•  ìˆ˜ ìˆì–´ìš”.
    ì˜ˆë¥¼ë“¤ì–´ willMigrateì—ì„œ ë³´ì´ëŠ”ê²ƒì²˜ëŸ¼ ë§ˆì´ê·¸ë ˆì´ì…˜ ë°œìƒ ì „ Tripì˜ ì¤‘ë³µì„ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    ì´ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë‹¤ ì§€ì •í–ˆìœ¼ë‹ˆ ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë™ì‘ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.
    ```swift
    struct TripsApp: App {
        let container = ModelContainer(
            for: Trip.self, 
            migrationPlan: SampleTripsMigrationPlan.self
        )

        var body: some Scene {
            WindowGroup {
                ContentView()
            }
            .modelContainer(container)
        }
    }
    ```
    í˜„ì¬ ìŠ¤í‚¤ë§ˆì™€ ë§ˆì´ê·¸ë ˆì´ì…˜ í”Œëœìœ¼ë¡œ ModelContainerë¥¼ ì„¤ì •í•˜ê¸°ë§Œ í•˜ë©´ ê°„ë‹¨íˆ ëë‚©ë‹ˆë‹¤ğŸ™ğŸ»

    ### ë§ˆë¬´ë¦¬

    ì•„ì£¼ ì‰¬ìš´ê²ƒ ê°™ì€ë° ì‹¤ì œë¡œ ì¨ë³´ë©´ ë‹¤ë¥¼ ìˆ˜ë„..?

    ### ì°¸ê³  ìë£Œ   
    https://green1229.tistory.com/379   
    https://developer.apple.com/wwdc23/10195   

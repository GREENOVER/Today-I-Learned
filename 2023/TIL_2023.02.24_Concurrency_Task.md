## TIL (Today I Learned)

### 2ì›” 24ì¼ (ê¸ˆ)    

- ### [í•™ìŠµë‚´ìš©] Swift Concurrency - Task (1)
    #### TaskëŠ” Swiftì˜ ë™ì‹œì„± ì‹œìŠ¤í…œ ë‚´ì—ì„œ ì–´ë–¤ ì—­í• ì„ í• ê¹Œìš”?

    ë¹„ë™ê¸° ì½”ë“œë¥¼ ì‘ì„±í•  ë•Œ Taskë¥¼ ìƒì„±í•˜ë©´ ë¹„ë™ê¸° APIë¥¼ ììœ ë¡­ê²Œ í˜¸ì¶œí•˜ê³  ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ìƒˆë¡œìš´ ë¹„ë™ê¸° ì»¨í…ìŠ¤íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    Taskë¥¼ ì‚¬ìš©í•˜ë©´ ë¹„ë™ê¸° ì½”ë“œë¥¼ ìº¡ìŠí™”í•  ìˆ˜ ìˆì„ ë¿ë§Œ ì•„ë‹ˆë¼ ì´ëŸ¬í•œ ì½”ë“œì˜ ì‹¤í–‰, ê´€ë¦¬ ê·¸ë¦¬ê³  ì ì¬ì ìœ¼ë¡œëŠ” ì·¨ì†Œë˜ëŠ” ë°©ì‹ê¹Œì§€ë„ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    #### ë™ê¸°ì‹ ì½”ë“œì™€ ë¹„ë™ê¸°ì‹ ì½”ë“œ ì‚¬ì´ì˜ ê²©ì°¨ í•´ì†Œ

    UI ê¸°ë°˜ì˜ ì•± ë‚´ì—ì„œ Taskë¥¼ ì‚¬ìš©í•˜ëŠ” ê°€ì¥ ì¼ë°˜ì ì¸ ë°©ë²•ì€ ë™ê¸°í™”ëœ main thread binding UI ì½”ë“œì™€ UIì—ì„œ ë Œë”ë§í•˜ëŠ” ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ì²˜ë¦¬í•˜ëŠ”ë° ì‚¬ìš©ë˜ëŠ” ëª¨ë“  ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì‚¬ì´ì˜ ë¸Œë¦¿ì§€ ì—­í• ì„ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
    ì˜ˆì‹œë¡œ ì•„ë˜ ì½”ë“œë¥¼ ë³´ì‹œì£ !
    ```swift
    class ProfileViewController: UIViewController {
        private let userID: User.ID
        private let loader: UserLoader
        private var user: User?
        ...

        override func viewWillAppear(_ animated: Bool) {
            super.viewWillAppear(animated)

            Task {
                do {
                    let user = try await loader.loadUser(withID: userID)
                    userDidLoad(user)
                } catch {
                    handleError(error)
                }
            }
        }

        ...

        private func handleError(_ error: Error) {
            // Show an error view
            ...
        }

        private func userDidLoad(_ user: User) {
            // Render the user's profile
            ...
        }
    }
    ```

    ë³´ì‹œë©´ UIKit ê¸°ë°˜ ProfileVC ë‚´ì˜ Taskë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹„ë™ê¸° APIë¥¼ ì‚¬ìš©í•´ VCê°€ ë Œë”ë§í•´ì•¼í•˜ëŠ” ì‚¬ìš©ì ëª¨ë¸ì„ ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    userDidLoadì— userë¥¼ ë„˜ê²¨ì¤Œìœ¼ë¡œì¨ ë§ì´ì£ .
    ì¦‰ ê·¸ì „ì— try awaitë¡œ APIë¥¼ í˜¸ì¶œí•˜ì—¬ userë¥¼ ì¶”ì¶œí•˜ê³  ì´ë¥¼ ë„˜ê²¨ì£¼ì£ .

    ì—¬ê¸°ì„œëŠ” ê¸°ì¡´ê³¼ ë‹¬ë¦¬ self capture, DispatchQueue.main.asycnì˜ í˜¸ì¶œ í˜¹ì€ í´ë¡œì €ë‚˜ combineê³¼ ê°™ì€ ë¹„ë™ê¸° ì‘ì—…ì„ ì²˜ë¦¬í•  ë•Œ ìˆ˜í–‰í•˜ëŠ” ì½”ìŠ¤íŠ¸ê°€ ë”ì´ìƒ ì—†ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

    ê·¸ëŸ¬ë©´ ë„ëŒ€ì²´ ì–´ë–»ê²Œ DispatchQueue.mainì„ ì“°ì§€ ì•Šê³  ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œ í›„ userDidLoadë‚˜ ì—ëŸ¬ ì²˜ë¦¬ë¥¼ í•´ì£¼ëŠ”ê²ƒê³¼ ê°™ì´ UI ì—…ë°ì´íŠ¸ë¥¼ ì‹œì¼œì¤„ ìˆ˜ ìˆëŠ”ê±¸ê¹Œìš”?

    ì—¬ê¸°ì„œ ì´ì œ Swiftì˜ MainActorë¼ëŠ” ê°œë…ì´ ë“±ì¥í•©ë‹ˆë‹¤.
    MainActorëŠ” ìë™ìœ¼ë¡œ UIê´€ë ¨ API(UIView, UIViewController ë‚´ ì •ì˜ëœ ê¸°ë³¸ API)ê°€ ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì ì ˆí•˜ê²Œ ë””ìŠ¤íŒ¨ì¹˜ ë˜ë„ë¡ ì œê³µí•´ì£¼ëŠ” ì†ì„±ì…ë‹ˆë‹¤.
    ì¦‰, Swiftì˜ Concurrencyë¥¼ ì‚¬ìš©í•˜ê³  MainActorê°€ í‘œì‹œëœ ì»¨í…ìŠ¤íŠ¸ ë‚´ì—ì„œ ë¹„ë™ê¸° ì½”ë“œë¥¼ ì‘ì„±í•˜ë©´ ì‹¤ìˆ˜ë¡œ ë°±ê·¸ë¼ìš´ë“œ íì—ì„œ UI ì—…ë°ì´íŠ¸ë¥¼ í•´ì£¼ëŠ” ì˜¤ë¥˜ì— ëŒ€í•´ ë”ì´ìƒ ê±±ì •í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤ğŸ™ğŸ»

    ë˜ ë¡œë“œ ì‘ì—…ì„ ì™„ë£Œí•˜ê¸° ìœ„í•´ ìˆ˜ë™ìœ¼ë¡œ ìœ ì§€í•˜ê³  ìˆì„ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
    Task handleì´ í• ë‹¹ í•´ì œ ë˜ì–´ë„ ë¹„ë™ê¸° ì‘ì—…ì´ ìë™ìœ¼ë¡œ ì·¨ì†Œë˜ì§€ ì•Šê³  ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì† ì‹¤í–‰ë©ë‹ˆë‹¤.

    #### Task ì°¸ì¡° ë° ì·¨ì†Œ

    ê°„í˜¹ íŠ¹ì •í•œ ê²½ìš°ì—ëŠ” ë¡œë“œ ì‘ì—…ì— ëŒ€í•´ ì°¸ì¡°ë¥¼ ìœ ì§€í•´ì•¼í•  ìˆ˜ ë„ ìˆìŠµë‹ˆë‹¤.
    ë§Œì•½ VCê°€ viewDisappearëœë‹¤ë©´ í•´ë‹¹ ì‘ì—…ì´ ì·¨ì†Œë  ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì´ì£ .
    í˜¹ì€ ì‘ì—…ì´ ì´ë¯¸ ì§„í–‰ì¤‘ì¸ ìƒíƒœì—ì„œ viewWillAppearê°€ í˜¸ì¶œë˜ë©´ ì¤‘ë³µ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê²Œ ë˜ë‹ˆ ì´ê²ƒë„ ë°©ì§€í•´ì•¼ í•  ìˆ˜ ìˆì£ .
    ```swift
    class ProfileViewController: UIViewController {
        private let userID: User.ID
        private let loader: UserLoader
        private var user: User?
        private var loadingTask: Task<Void, Never>?
        ...

        override func viewWillAppear(_ animated: Bool) {
            super.viewWillAppear(animated)

            guard loadingTask == nil else {
                return
            }

            loadingTask = Task {
                do {
                    let user = try await loader.loadUser(withID: userID)
                    userDidLoad(user)
                } catch {
                    handleError(error)
                }

                loadingTask = nil
            }
        }

        override func viewDidDisappear(_ animated: Bool) {
            super.viewDidDisappear(animated)
            loadingTask?.cancel()
            loadingTask = nil
        }

        ...
    }
    ```
    ì°¸ì¡°ëŠ” ì´ì™€ ê°™ì´ loadingTaskë¼ëŠ” Task ë³€ìˆ˜ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
    Taskì—ëŠ” ë‘ê°€ì§€ ìœ í˜•ì´ ìˆì–´ìš”.
    ì œë„¤ë¦­í•˜ê²Œ ë¨¼ì € ë“¤ì–´ì˜¤ëŠ”ê²ƒì€ ë°˜í™˜í•˜ëŠ” ì¶œë ¥ì˜ ìœ í˜•ì„ ë‚˜íƒ€ë‚´ê³  ë‘ë²ˆì§¸ë¡œ ë“¤ì–´ì˜¤ëŠ”ê²ƒì€ í”íˆ ì•„ëŠ” ì˜¤ë¥˜ ìœ í˜•ì…ë‹ˆë‹¤.
    ì¦‰ Resultì™€ ë¹„ìŠ·í•œ í˜•íƒœì´ì£ .
    ìœ„ ì½”ë“œì—ì„œ loadingTaskê°€ nil ì¦‰ ì—†ìœ¼ë©´ ì¢…ë£Œí•˜ê²Œ í•´ë‘” ì´ìœ ëŠ” ë°”ë¡œ ë°‘ì— Taskë¥¼ ë„£ì–´ì£¼ê³  nilë¡œ ì„¤ì •í•´ì£¼ê¸° ë•Œë¬¸ì´ì£ .
    ì¦‰ ì¤‘ë³µë˜ì§€ ì•Šë„ë¡ í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.
    ê·¸ë¦¬ê³  viewDidDisappearê°€ ë¶ˆë¦´ë•Œ loadingTaskë¥¼ cancelí•˜ê³  í•´ë‹¹ ê°’ë„ nilë¡œ ë³€ê²½í•´ì£¼ì£ .
    ì¦‰ ì‘ì—…ì´ ì·¨ì†Œëœê±¸ ì•Œë ¤ì£¼ëŠ”ê²ë‹ˆë‹¤.
    ë˜í•œ ë‚´ë¶€ì—ì„œë„ ë¡œë“œ ì‘ì—…ì´ ì·¨ì†Œë©ë‹ˆë‹¤.

    #### ì»¨í…ìŠ¤íŠ¸ ìƒì†

    ìµœì†Œ ë·° ë° ë·°ì»¨ê³¼ ê°™ì€ @MainActorê°€ ë¶™ëŠ” í´ë˜ìŠ¤ ë‚´ì—ì„œëŠ” ìš”ì²­í•œ ì‘ì—…ê³¼ ìƒìœ„ ì‘ì—… ê°„ì˜ ê´€ê³„ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤.
    í•˜ìœ„ ì‘ì—…ì€ ì·¨ì†Œ ì¸¡ë©´ì—ì„œ ìƒìœ„ ì‘ì—…ê³¼ ì—°ê²°ë˜ë©´ì„œ ìƒìœ„ ì‘ì—…ì´ ì‚¬ìš©í•˜ëŠ”ê²ƒê³¼ ë™ì¼í•œ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ìƒì†í•©ë‹ˆë‹¤.
    ì¼ë‹¨ ì½”ë“œë¥¼ ë³´ë©´ì„œ ì–˜ê¸°í•´ë³´ì‹œì£ !
    ```swift
    class ProfileViewController: UIViewController {
        private let userID: User.ID
        private let database: Database
        private var user: User?
        private var loadingTask: Task<Void, Never>?
        ...

        override func viewWillAppear(_ animated: Bool) {
            super.viewWillAppear(animated)

            guard loadingTask == nil else {
                return
            }

            loadingTask = Task {
                do {
                    let user = try database.loadModel(withID: userID)
                    userDidLoad(user)
                } catch {
                    handleError(error)
                }

                loadingTask = nil
            }
        }

        ...
    }
    ```
    ì—¬ê¸°ì„œ databaseê°€ ë³€ìˆ˜ê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤.
    ProfileVCê°€ ì„œë²„ í†µì‹ ì´ ì•„ë‹Œ ë¡œì»¬ DBì—ì„œ ì‚¬ìš©ì ëª¨ë¸ì„ ë¡œë“œí•˜ê³  DB APIê°€ ì™„ì „í•œ ë™ê¸°í™”ê°€ ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•œ ì½”ë“œì…ë‹ˆë‹¤.
    try database.loadModel(withID: userID)í•´ì£¼ëŠ” ë¹„ë™ê¸° ì‘ì—…ì´ ìš°ë¦¬ëŠ” ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë ê±°ë¼ ì˜ˆìƒí•˜ê¸°ì— ë¬¸ì œê°€ ì—†ì–´ ë³´ì…ë‹ˆë‹¤.

    ê·¸ëŸ°ë° ì‹¤ì œë¡  í•´ë‹¹ ì‘ì—…ì€ ë¹„ë™ê¸°ì  ìˆ˜í–‰ì€ ë§ì§€ë§Œ MainActorë¥¼ ì‚¬ìš©í•´ ë””ìŠ¤íŒ¨ì¹˜ ë˜ê¸°ì— ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    ì¦‰, ê¸°ë³¸ì ìœ¼ë¡œ DispatchQueue.main.async í´ë¡œì € ë‚´ì—ì„œ DB í˜¸ì¶œì„ ìˆ˜í–‰í•˜ëŠ”ê²ƒê³¼ ê°™ì€ê²ƒì´ì£ .

    ê·¸ëŸ¼ ì•„ë˜ ì½”ë“œëŠ” ì–´ë–¨ê¹Œìš”?
    ```swift
    class ProfileViewController: UIViewController {
        ...

        override func viewWillAppear(_ animated: Bool) {
            super.viewWillAppear(animated)

            guard loadingTask == nil else {
                return
            }

            loadingTask = Task.detached(priority: .userInitiated) { [weak self] in
                guard let self = self else { return }

                do {
                    let user = try self.database.loadModel(withID: self.userID)
                    await self.userDidLoad(user)
                } catch {
                    await self.handleError(error)
                }

                await self.loadingTaskDidFinish()
            }
        }

        ...

        private func loadingTaskDidFinish() {
            loadingTask = nil
        }
    }
    ```
    ë§Œì•½ DB í˜¸ì¶œì„ ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ë²—ì–´ë‚˜ detached Task ì¦‰ ë¶„ë¦¬ëœ Taskë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ì´ TaskëŠ” ë…ë¦½ì ì¸ ì»¨í…ìŠ¤íŠ¸ ë‚´ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    ì´ë ‡ê²Œ í•œë‹¤ë©´ VCì˜ ë©”ì„œë“œë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•  ë•Œë„ awaitë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
    ì¼ë°˜ì ìœ¼ë¡œ ë…ë¦½ì ì¸ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ìµœìƒìœ„ ì‘ì—…ì„ ëª…ì‹œì ìœ¼ë¡œ ìƒì„±í•˜ë ¤ëŠ” ê²½ìš° detached Taskë§Œ ì‚¬ìš©í•˜ëŠ”ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
    ë‹¤ë¥¸ ê²½ìš°ì—ëŠ” Task { }ë¥¼ ì´ìš©í•´ ë¹„ë™ê¸° ì½”ë“œë¥¼ ìº¡ìŠí™”í•˜ëŠ”ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

    #### Await - Task Result

    ì´ì œ Task ì¸ìŠ¤í„´ìŠ¤ì˜ resultë¥¼ awaití•˜ëŠ” ë°©ë²•ì„ ë³´ê² ìŠµë‹ˆë‹¤.
    ì˜ˆì‹œë¡œ, ì„œë²„ í†µì‹ ì„ í†µí•´ ì‚¬ìš©ìì˜ ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ëŠ” ì§€ì›ìœ¼ë¡œ ìœ„ì˜ ì˜ˆì‹œë¡œ ë‹¤ë¤˜ë˜ DB ê¸°ë°˜ VC êµ¬í˜„ì„ í™•ì¥í•´ë³¼ê»˜ìš”!
    ```swift
    class ProfileViewController: UIViewController {
      private let userID: User.ID
      private let database: Database
      private let imageLoader: ImageLoader
      private var user: User?
      private var loadingTask: Task<Void, Never>?
      ...

      override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)

        guard loadingTask == nil else {
          return
        }

        loadingTask = Task {
          let databaseTask = Task.detached(
            priority: .userInitiated,
            operation: { [database, userID] in
              try database.loadModel(withID: userID)
            }
          )

          do {
            let user = try await databaseTask.value
            let image = try await imageLoader.loadImage(from: user.imageURL)
            userDidLoad(user, image: image)
          } catch {
            handleError(error)
          }

          loadingTask = nil
        }
      }

      ...

      private func userDidLoad(_ user: User, image: UIImage) {
        // Render the user's profile
        ...
      }
    }
    ```
    ì´ë¥¼ ìœ„í•´ detached Taskë¥¼ ë‹¤ë¥¸ Task ì¸ìŠ¤í„´ìŠ¤ ë‚´ì— ì •ë¦¬í•˜ê³  await í‚¤ì›Œë“œë¥¼ ì´ìš©í•´ DB ë¡œë“œ ì‘ì—…ì´ ì™„ë£Œë ë•Œ ê¹Œì§€ ê¸°ë‹¤ë¦° í›„ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.

    ë³´ì‹œë©´ ì´ì „ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ MainActorì— ë°”ì¸ë”©ë˜ì—ˆê¸°ì— VCì˜ ë©”ì„œë“œë¥¼ ìµœìƒìœ„ ì‘ì—… ë‚´ì—ì„œ ë‹¤ì‹œ í•œë²ˆ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ë°©ë²•ì—ë§Œ ìœ ì˜í•˜ë©´ ë©ë‹ˆë‹¤.
    ìœ„ íë¦„ì„ ë³´ë©´ ì´ì œëŠ” ì‹¤ìˆ˜ë¡œ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ UI ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜í–‰í•  ê±±ì •ë„ ì—†ê³  ë©”ì¸ íì™€ ì™¸ë¶€ì—ì„œ ìˆ˜í–‰í•œ ì‘ì—…ì´ ê½¤ë‚˜ ì›í™œí•˜ê²Œ í˜¼í•©ë˜ì—ˆìŠµë‹ˆë‹¤ğŸ™Œ

    #### ê²°ë¡ 

    Taskë¥¼ ì‚¬ìš©í•˜ë©´ ë¹„ë™ê¸° ì‘ì—… ë‹¨ìœ„ë¥¼ ìº¡ìŠí™”ë„ í•  ìˆ˜ ìˆê³  ê´€ì°°/ì œì–´ë„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ì´ë¥¼ í†µí•´ ë¹„ë™ê¸° APIë¥¼ í˜¸ì¶œí•˜ê³  ì™„ì „íˆ ë™ê¸°í™”ëœ ì½”ë“œ ë‚´ì—ì„œë„ ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆì£ .
    ì¦‰, ìš°ë¦¬ëŠ” ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì—¼ë‘ì— ë‘ê³  ì„¤ê³„ë˜ì§€ ì•Šì€ ì•± ë‚´ì—ì„œë„ ë¹„ë™ê¸° ê¸°ëŠ¥ê³¼ ìƒˆë¡œìš´ Swift Concurrencyì˜ ê¸°ëŠ¥ë“¤ì„ ì ì§„ì ìœ¼ë¡œ ë„ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

    #### ë§ˆë¬´ë¦¬

    ì•„ë§ˆë„ ë§ì€ ë¶„ë“¤ì´ë‚˜ íšŒì‚¬ì—ì„œë„ Swift Concurrencyì— ê´€ì‹¬ì´ ë§ì„ê±°ë¼ ì˜ˆìƒí•©ë‹ˆë‹¤.
    ë‹¤ë§Œ í˜„ì¬ êµ¬ì¡°ì—ì„œ ì–´ë–»ê²Œ ë³€ê²½í•´ì•¼í• ì§€ ë§‰ë§‰í• í…ë°ìš”.
    í˜„ì¬ êµ¬ì¡°ë¥¼ ë‹¤ ê°ˆì•„ì—ì§€ ì•Šìœ¼ë©´ì„œ ì ì§„ì ìœ¼ë¡œ ì¶©ë¶„íˆ ë„ì…í•  ìˆ˜ ìˆë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤ğŸ˜²

    #### [ì°¸ê³  ìë£Œ]
    https://green1229.tistory.com/332   
    https://www.swiftbysundell.com/articles/the-role-tasks-play-in-swift-concurrency/
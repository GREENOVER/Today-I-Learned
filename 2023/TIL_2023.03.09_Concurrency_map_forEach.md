## TIL (Today I Learned)

### 3ì›” 9ì¼ (ëª©)    

- ### [í•™ìŠµë‚´ìš©] Swift Concurrency - map & forEach
    #### ë™ê¸° ë³€í™˜

    ìš°ì„  ìš°ë¦¬ê°€ ì•„ì£¼ ìµìˆ™í•œ êµ¬ì¡°ë¶€í„° ë³¼ê»˜ìš”.
    ```swift
    class MovieListViewController: UIViewController {
        private var movies: [Movie]
        private let favoritesManager: FavoritesManager
        private lazy var tableView = UITableView()
        ...

        func markSelectedMoviesAsFavorites() {
            tableView.indexPathsForSelectedRows?.forEach { indexPath in
                let movie = movies[indexPath.row]
                favoritesManager.markMovieAsFavorite(movie)
            }
        }
    }
    ```
    ì ì´ë ‡ê²Œ VCì—ì„œ íŠ¹ì • ì˜í™”ë¥¼ ì¦ê²¨ì°¾ê¸°ë¡œ í‘œì‹œí•  ìˆ˜ ìˆëŠ” ì½”ë“œê°€ ìˆìŠµë‹ˆë‹¤.
    ë‚´ë¶€ì—ì„œ forEachë¥¼ í†µí•´ ì‚¬ìš©ìê°€ ì„ íƒí•œ ì¸ë±ìŠ¤ ê²½ë¡œë¥¼ ë°˜ë³µí•˜ë©° í•´ë‹¹í•˜ëŠ” ì˜í™”ë¥¼ ì¦ê²¨ì°¾ê¸° í‘œì‹œí•˜ê¸° ìœ„í•´ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì£ .

    ì—¬ê¸°ê¹Œì§€ëŠ” ì•„ì£¼ ìµìˆ™í•˜ì£ ?
    ```swift
    class FavoritesManager {
        private let database: Database
        private var favoriteIDs = Set<Movie.ID>()
        ...

        func loadFavorites() throws -> [Movie] {
            try favoriteIDs.map { id in
                try database.loadMovie(withID: id)
            }
        }

        func markMovieAsFavorite(_ movie: Movie) {
            ...
        }
    }
    ```
    ìœ„ì²˜ëŸ¼ ë” ë‚˜ì•„ê°€ì„œ FavoriteManagerì—ì„œ ì´ì „ì— ì¦ê²¨ì°¾ê¸°í•œ ì˜í™” ëª¨ë¸ì„ ë¡œë“œí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
    í•´ë‹¹ ë‚´ë¶€ì—ì„œëŠ” mapì„ ì‚¬ìš©í•´ DBì—ì„œ ê²€ìƒ‰í•˜ê³  ì˜í™” IDë¥¼ ì‹¤ì œ ëª¨ë¸ë¡œ ë³€í™˜í•´ì¤ë‹ˆë‹¤.

    ì—¬ê¸°ê¹Œì§€ë„ ì•„ì£¼ì•„ì£¼ ìµìˆ™í•œ ê·¸ë¦¼ì…ë‹ˆë‹¤!
    ì´ì œ ê·¸ëŸ¼ Concurrencyë¥¼ ì´ìš©í•´ ìœ„ ì‘ì—…ë“¤ì„ ë¹„ë™ê¸°ì ì´ê³  ì‹¤í–‰ ì‹œ ë¸”ë¡ì´ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ” ë¹„ì°¨ë‹¨ì ì¸ ë°©ì‹ìœ¼ë¡œ ë³€í™˜ì‹œì¼œë³´ì£ ğŸ™Œ

    #### ë¹„ë™ê¸°í™”

    ìš°ì„  ìš°ë¦¬ê°€ ëŠ˜ ë¨¹ë˜ async/awaitë¥¼ í†µí•´ í•´ë‹¹ ì‘ì—…ì„ ì•„ë˜ì²˜ëŸ¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ```swift
    class FavoritesManager {
        ...

        func markMovieAsFavorite(_ movie: Movie) async {
            ...
        }

        func loadFavorites() async throws -> [Movie] {
            try await favoriteIDs.map { id in
                try await database.loadMovie(withID: id)
            }
        }
    }
    ```
    ì´ë ‡ê²Œ ë§ì´ì£ !
    ê·¼ë° ì´ê±° ì»´íŒŒì¼ì´ ì•ˆë©ë‹ˆë‹¤ã…ã…...
    ì™œëƒë©´ mapì€ ê¸°ë³¸ Swiftì—ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì¸ë° ì•„ì‰½ê²Œë„ ì•„ì§ Swift ìµœì‹  ë²„ì „ì—ì„œë„ mapì´ ë¹„ë™ê¸° í´ë¡œì €ë¥¼ ì§€ì›í•˜ì§€ ì•Šê¸°ì— ì‹¤ì œ ì»´íŒŒì¼ì´ ë˜ì§„ ì•ŠìŠµë‹ˆë‹¤.

    ê·¸! ë ‡! ì§€! ë§Œ! ìš°ë¦¬ëŠ” Swiftì˜ ì•„ì£¼ ì¢‹ì€ Extensionì´ë¼ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ë³¼ ìˆ˜ ìˆì–´ìš”.
    Swiftì—ì„œ ì¼ë°˜ì ìœ¼ë¡œ ë‹¤ì–‘í•œ ì»¬ë ‰ì…˜ì—ì„œ ìˆ˜í–‰í•˜ëŠ” ëŒ€ë¶€ë¶„ì˜ ì‘ì—…ì¸ forEach, map, flatMapê³¼ ê°™ì€ ë…€ì„ë“¤ì€ ì‹œí€€ìŠ¤ í”„ë¡œí† ì½œì„ í™•ì¥í•˜ì—¬ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ì‹œí€€ìŠ¤ í”„ë¡œí† ì½œì€ Array, Set, Dictionaryì™€ ê°™ì€ ë‚´ì¥ ì»¬ë ‰ì…˜ì´ ëª¨ë‘ ì¤€ìˆ˜í•˜ëŠ” í”„ë¡œí† ì½œì…ë‹ˆë‹¤.
    ë˜í•œ, Swiftì˜ ë£¨í”„ ë™ì‘ì—ì„œë„ ì‚¬ìš©ë˜ëŠ” í”„ë¡œí† ì½œì´ê¸°ë„ í•˜ì£ !

    ê·¸ë ‡ê¸°ì— ìš°ë¦¬ëŠ” Sequenceë¥¼ í™•ì¥í•´ë³¼ê»˜ìš”ğŸ‰
    ```swift
    extension Sequence {
        func asyncMap<T>(
            _ transform: (Element) async throws -> T
        ) async rethrows -> [T] {
            var values = [T]()

            for element in self {
                try await values.append(transform(element))
            }

            return values
        }
    }
    ```
    ì ìš”ë ‡ê²Œ asyncMapì„ ë§Œë“¤ì–´ë³´ì£ .
    ìš°ì„  transformì´ë¼ëŠ” íŒŒë¼ë¯¸í„°ì— ë¹„ë™ê¸° í´ë¡œì €ë¥¼ ë„£ì–´ì¤„ ìˆ˜ ìˆë„ë¡ í•´ë´…ë‹ˆë‹¤.
    í•´ë‹¹ transform í´ë¡œì € ë¸”ë¡ì€ self ìê¸° ìì‹ ì„ ê°€ì§€ê³  forë¬¸ì„ ëŒë©° ì‹¤í–‰í•˜ê³  valuesì— ì¶”ê°€í•©ë‹ˆë‹¤.

    ì—¬ê¸°ì„œ í•´ë‹¹ ë§Œë“¤ì–´ì§„ asyncMap ë©”ì„œë“œì— rethrows í‚¤ì›Œë“œê°€ ë¶™ì—ˆì–´ìš”!
    ì´ê±´ ì»´íŒŒì¼ëŸ¬ê°€ ìš°ë¦¬ê°€ ë§Œë“  ì´ëŸ° ìƒˆë¡œìš´ ë°©ë²•ì„ throwsí•œê±¸ë¡œ ì·¨ê¸‰í•˜ë„ë¡ ì§€ì‹œí•©ë‹ˆë‹¤.
    ì´ëŠ” í´ë¡œì €ê°€ throwí•˜ì§€ ì•Šì„ ë•Œì—ë„ ìš°ë¦¬ê°€ í•­ìƒ tryë¡œ ìƒˆ ë©”ì„œë“œë¥¼ í˜¸ì¶œ í•  í•„ìš” ì—†ì´ í•„ìš”í•  ë•Œ ì˜¤ë¥˜ë¥¼ ë˜ì§ˆ ìˆ˜ ìˆëŠ” ìœ ì—°ì„±ì„ ì œê³µí•œë‹¤ê³  í•´ìš”.

    ì ë‹¤ì‹œ ëŒì•„ê°€ì„œ, ìœ„ì˜ ì½”ë“œë¥¼ ì´ìš©í•´ì„œ ì‚¬ìš©í•´ë³¼ê»˜ìš”.
    ```swift
    class FavoritesManager {
        ...

        func loadFavorites() async throws -> [Movie] {
            try await favoriteIDs.asyncMap { id in
                try await database.loadMovie(withID: id)
            }
        }
    }
    ```
    ì´ë ‡ê²Œ ê¸°ì¡´ì—ëŠ” awaitë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í–ˆë˜ mapì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë³€í™˜í–ˆìŠµë‹ˆë‹¤.
    ì‹¤ì œë¡œ ì»´íŒŒì¼ë„ ë˜êµ¬ìš”ğŸ˜„

    ê·¸ëŸ¼ ë‹¤ìŒìœ¼ë¡œ forEachë„ ë³´ì‹œì£ !

    forEachë¥¼ ê·¸ëƒ¥ ë‘ë©´ ì‚¬ìš©ìê°€ ì„ íƒí•œ ì˜í™”ë¥¼ ì¦ê²¨ì°¾ê¸°ë¡œ í‘œì‹œí•˜ëŠ” ë™ì•ˆ ë©”ì¸ ìŠ¤ë ˆë“œê°€ ë§‰íˆê¸°ì— UIì  ë‹¤ë¥¸ ì‘ì—…ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    ì´ë¥¼ ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ í†µí•´ ë°”ê¿”ë³¼ê»˜ìš”.
    ```swift
    extension Sequence {
        func asyncForEach(
            _ operation: (Element) async throws -> Void
        ) async rethrows {
            for element in self {
                try await operation(element)
            }
        }
    }
    ```
    ë™ì¼í•˜ê²Œ ì‹œí€€ìŠ¤ë¥¼ í™•ì¥ì‹œì¼œ asyncForEachë¼ëŠ” ìƒˆë¡œìš´ ë©”ì„œë“œë¥¼ ë§Œë“­ë‹ˆë‹¤.
    async ë©”ì„œë“œì´ê³  ë™ì¼í•˜ê²Œ ë‚´ë¶€ì—ì„œ ì¡°ê±´ë¬¸ì„ ëŒë©° ì‹¤í–‰ë°›ì•„ì˜¨ ë¹„ë™ê¸° í´ë¡œì €ë¥¼ ì‹¤í–‰ì‹œí‚µë‹ˆë‹¤.

    ì—¬ê¸°ì„œ ì£¼ì˜í•  ë¶€ë¶„ì€ ë¹„ë™ê¸°ë¡œ forEachë¥¼ ì²˜ë¦¬í•˜ê¸°ì— í•´ë‹¹ ì‘ì—…ì´ ì§„í–‰ë˜ëŠ” ë™ì•ˆ ì˜í™” ë¦¬ìŠ¤íŠ¸ì˜ ê°’ì´ ë³€ê²½ë  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
    ê·¸ëŸ¼ìœ¼ë¡œ ì´ëŸ¬í•œ ìƒí™©ì—ì„œ ì¶©ëŒì´ ì¼ì–´ë‚˜ì§€ ì•Šë„ë¡ í•´ë‹¹ ë¦¬ìŠ¤íŠ¸ë¥¼ ìº¡ì³í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤!
    ```swift
    class MovieListViewController: UIViewController {
        ...

        func markSelectedMoviesAsFavorites() {
            Task {
                await tableView.indexPathsForSelectedRows?.asyncForEach { 
                    [movies] indexPath in

                    let movie = movies[indexPath.row]
                    await favoritesManager.markMovieAsFavorite(movie)
                }
            }
        }
    }
    ```
    ì ì´ë ‡ê²Œ ìš°ë¦¬ëŠ” mapê³¼ forEachë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë™ì‘ì‹œí‚¤ë©´ì„œ UIë¥¼ ë§‰ì§€ ì•ŠëŠ” êµ¬í˜„ì„ ì™„ì„±í–ˆìŠµë‹ˆë‹¤!

    ê·¸ëŸ°ë° ë¹„ë™ê¸°ì ì¸ê²ƒë„ ì¢‹ì€ë° ìš°ë¦¬ëŠ” í•œë‹¨ê³„ ë” ë‚˜ì•„ê°€ì„œ ì´ê±¸ ë™ì‹œì ìœ¼ë¡œ í’€ì–´ë³¼ê¹Œí•´ìš”ğŸ•ºğŸ»

    #### ë™ì‹œì„±

    ìœ„ ì‘ì—…ë“¤ë¡œ ë¹„ë™ê¸°ëŠ” ë‹¤ ì¢‹ì•˜ì–´ìš”.
    ê·¸ë ‡ì§€ë§Œ ì‘ì—…ì˜ ì†ë„ë¥¼ ë†’ì—¬ì£¼ì§„ ì•ŠëŠ”ê±´ ì‚¬ì‹¤ì…ë‹ˆë‹¤.
    ì™œëƒ? ìˆœì°¨ì ìœ¼ë¡œ ì§„í–‰ë˜ë‹¤ë³´ë‹ˆ ê·¸ë ‡ì£ .
    ê·¸ë ‡ê¸°ì— ì´ ì‘ì—…ë“¤ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰í•˜ë„ë¡ êµ¬í˜„í•´ë´ì•¼í•©ë‹ˆë‹¤.
    ```swift
    extension Sequence {
        func concurrentForEach(
            _ operation: @escaping (Element) async -> Void
        ) async {
            // A task group automatically waits for all of its
            // sub-tasks to complete, while also performing those
            // tasks in parallel:
            await withTaskGroup(of: Void.self) { group in
                for element in self {
                    group.addTask {
                        await operation(element)
                    }
                }
            }
        }
    }
    ```
    ì €ë²ˆ í¬ìŠ¤íŒ…ì—ì„œ ë´¤ë˜ Task ê·¸ë£¹ì„ í†µí•œ Parallel ì²˜ë¦¬ê°€ ë³´ì´ë„¤ìš”!
    ì•„ê¹Œ ë§Œë“  asyncForEachë¥¼ withTaskGroupìœ¼ë¡œ ê°ì‹¸ì£¼ê³  ë‚´ë¶€ì—ì„œ addTaskë¡œ ê·¸ë£¹ì— Taskë¥¼ ë„£ì–´ì¤Œìœ¼ë¡œ
    ê° operationì´ ë³‘ë ¬ì ìœ¼ë¡œ ì¼ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ```swift
    class MovieListViewController: UIViewController {
        ...

        func markSelectedMoviesAsFavorites() {
            Task {
                await tableView.indexPathsForSelectedRows?.concurrentForEach {
                    [movies, favoritesManager] indexPath in

                    let movie = movies[indexPath.row]
                    await favoritesManager.markMovieAsFavorite(movie)
                }
            }
        }
    }
    ```
    ì´ì   ìš”ë ‡ê²Œ forEachë¥¼ ëŒë ¤ì£¼ë©´ì„œ ë¹„ë™ê¸°ì ì´ê³ ë„ ë³‘ë ¬ì ìœ¼ë¡œ ë¹ ë¥¸ ì‘ì—…ì„ í•´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ì—¬ê¸°ì„œ ìº¡ì³ë¦¬ìŠ¤íŠ¸ë¡œ moviesì™€ favoriteManagerë§Œì„ ë‹´ê³  ìˆëŠ” ì´ìœ ëŠ” ì „ë¶€ selfë¡œ ìº¡ì³í•´ ê°€ì ¸ì˜¤ê¸°ë³´ë‹¤ ì‘ì—… ìˆ˜í–‰ì— í•„ìš”í•œ ì‹¤ì œ ê°œì²´ë“¤ë§Œ ìº¡ì³í•˜ëŠ”ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

    ì ê·¸ëŸ¼ ì´ì–´ì„œ mapë„ ê·¸ë ‡ê²Œ ì²˜ë¦¬í•´ë³¼ê¹Œìš”?

    mapì€ forEachì²˜ëŸ¼ TaskGroupì„ ì‚¬ìš©í•˜ì—¬ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    ì™œëƒí•˜ë©´ mapì€ ë°ì´í„°ë¥¼ ê°€ì§€ê³  ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ë³€í™˜í•˜ê³  ê·¸ ìˆœì„œë¥¼ ì§€ì¼œ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤.
    ê·¸ëŸ°ë° TaskGroupì„ ì‚¬ìš©í•œë‹¤ë©´ ë‚´ë¶€ ê·¸ë£¹ì—ì„œ Taskë“¤ì´ ì™„ì „í•œ ë³‘ë ¬ì´ê³  ë°˜í™˜ë˜ê¸°ì— ì–´ë–¤ê²ƒì´ ë¨¼ì € ë°˜í™˜ë˜ì•¼ í•˜ëŠ”ì§€ ì»¨íŠ¸ë¡¤ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    ì¦‰, ì™„ë£Œ ìˆœì„œ ì¸¡ë©´ì—ì„œ ì–´ë– í•œ ë³´ì¥ë„ í•  ìˆ˜ ì—†ê³  ì…ë ¥ê³¼ëŠ” ë‹¤ë¥¸ ì¶œë ¥ ìˆœì„œë¥¼ ë‚´ë±‰ì„ê±°ì—ìš”ã… ã… 

    ê·¸ë ‡ê¸°ì— ì•„ë˜ì²˜ëŸ¼ í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ```swift
    extension Sequence {
        func concurrentMap<T>(
            _ transform: @escaping (Element) async throws -> T
        ) async throws -> [T] {
            let tasks = map { element in
                Task { 
                    try await transform(element)
                }
            }

            return try await tasks.asyncMap { task in
                try await task.value
            }
        }
    }
    ```
    concurrentMapì„ ë§Œë“¤ì–´ë³´ì£ !
    TaskGroupì„ ì‚¬ìš©í•˜ë©´ ì•ˆë˜ë‹ˆ ê° ìš”ì†Œì— ëŒ€í•´ ë¹„ë™ê¸° ì‘ì—…ì„ ìƒì„±í•˜ëŠ”ê²ƒì„ ì‹œì‘í•œ ë‹¤ìŒ ì´ì „ì˜ ë¹„ë™ê¸° mapì„ ë§Œë“  asyncMap ë©”ì„œë“œë¥¼ í†µí•´ ë¹„ë™ê¸°ì ìœ¼ë¡œ ëŒë¦¬ê³  ê²°ê³¼ë¥¼ ìˆœì„œëŒ€ë¡œ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
    ë¬¼ë¡  ê²°ê³¼ë¥¼ ìˆœì„œëŒ€ë¡œ ê¸°ë‹¤ë¦¬ëŠ” ì‹œê°„ì€ ìˆì§€ë§Œ í•´ë‹¹ ì‘ì—…ë“¤ì„ ë¹„ë™ê¸°ë¡œ ê·¸ë¦¬ê³  ë˜ ë³‘ë ¬ì ìœ¼ë¡œ ì²˜ë¦¬í–ˆê¸°ì— ê¸°ì¡´ ìˆœì°¨ì ì¸ ì²˜ë¦¬ë³´ë‹¨ ì†ë„ê°€ í›¨ì”¬ ë¹ ë¥¼ê±°ë¼ ìƒê°í•©ë‹ˆë‹¤.
    ```swift
    class FavoritesManager {
        ...

        func loadFavorites() async throws -> [Movie] {
            try await favoriteIDs.concurrentMap { [database] id in
                try await database.loadMovie(withID: id)
            }
        }
    }
    ```
    ë§Œë“¤ì–´ì§„ concurrentMapì€ ì´ì œ ìš”ë ‡ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆê² ì£ ?

    #### ê²°ë¡ 

    compatMapì´ë‚˜ flatMapë„ ì´ëŸ° êµ¬í˜„ì„ í†µí•´ í•´ë³´ì‹œê¸¸ ì¶”ì²œë“œë¦½ë‹ˆë‹¤ğŸ‘

    #### ë§ˆë¬´ë¦¬

    ë¹„ë™ê¸°ì ì´ê³  ë³‘ë ¬ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ë©´ì„œ ì„±ëŠ¥ì˜ ì´ì ì„ ê³ ë ¤í•˜ëŠ” extension êµ¬í˜„ì„ ì‚¬ì‹¤ í¬ê²Œ ìƒê°ì„ ëª»í–ˆì—ˆëŠ”ë° ë§ì€ ê·€ê°ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.
    ì‚¬ì‹¤ mapì„ ë³‘ë ¬ì ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤ëŠ” ê²ƒì´ ì •ë§ ê°ì´ ì•ˆì™”ëŠ”ë° ì–´ëŠì •ë„ ë£¨íŠ¸ë¥¼ ì¡ì•„ì¤¬ë˜ í•™ìŠµì´ì˜€ìŠµë‹ˆë‹¤ğŸ‰

    #### [ì°¸ê³  ìë£Œ]
    https://green1229.tistory.com/337   
    https://www.swiftbysundell.com/articles/async-and-concurrent-forEach-and-map/
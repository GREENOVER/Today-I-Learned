## TIL (Today I Learned)

### 10ì›” 30ì¼ (ì›”)    

  ### [í•™ìŠµë‚´ìš©] Swiftì˜ Small String Optimization      
  ### ì„œë¡œ ë‹¤ë¥¸ String ë°ì´í„°ë“¤ì´ ê°™ì€ Heap ì£¼ì†Œë¥¼ ê°€ë¥´í‚¨ë‹¤?

ìš°ì„  ì•„ë˜ì™€ ê°™ì€ ì½”ë“œê°€ ìˆë‹¤ê³  ê°€ì •í•´ë´…ì‹œë‹¤!

```swift
import Foundation

var firstStr: String = "green"
var secondStr: String = "red"

// MARK: - Stack ë©”ëª¨ë¦¬ ì˜ì—­ ì£¼ì†Œ ì¶œë ¥
func printStackAddress(input: inout String) {
  withUnsafePointer(to: &input) { pointer in
      print("The stack memory address is \(pointer)")
  }
}

// MARK: - Heap ë©”ëª¨ë¦¬ ì˜ì—­ ì£¼ì†Œ ì¶œë ¥
func printHeapAddress(address input: UnsafeRawPointer) {
    print(String(format: "The heap memory address is %p", Int(bitPattern: input)))
}

printStackAddress(input: &firstStr)
printStackAddress(input: &secondStr)
printHeapAddress(address: firstStr)
printHeapAddress(address: secondStr)

// The stack memory address is 0x0000000100008018
// The stack memory address is 0x0000000100008028
// The heap memory address is 0x600000c08260
// The heap memory address is 0x600000c08260
```
 
ëª…ë°±íˆ ì„œë¡œ ë‹¤ë¥¸ String ë°ì´í„°ì…ë‹ˆë‹¤.
ë³µì‚¬ë¥¼ í•˜ì§€ë„ ì•Šì•˜êµ¬ìš”!
ê·¸ëŸ°ë° ê°™ì€ Heap ì£¼ì†Œë¥¼ ì¶œë ¥í•˜ê³  ìˆì–´ìš”.
 
ë„ëŒ€ì²´ ì™œ ê·¸ëŸ´ê¹Œìš”?
 
ì—¬ê¸°ì„œ ì°¾ì•„ë³´ê³  ì•Œì•„ë´¤ë˜ê±´ ë‘ê°€ì§€ ê°€ì •ë“¤ê³¼ ê²°ë¡ ì´ì˜€ìŠµë‹ˆë‹¤.
 
Swiftì—ì„  ì§ì ‘ì ìœ¼ë¡œ Heap ë©”ëª¨ë¦¬ ì£¼ì†Œì— ì ‘ê·¼ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤!

Swiftì—ì„œëŠ” ë§ ê·¸ëŒ€ë¡œ ì§ì ‘ì ìœ¼ë¡œ Heap ë©”ëª¨ë¦¬ ì£¼ì†Œì— ì ‘ê·¼ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì‚¬ì‹¤ì…ë‹ˆë‹¤.
ê·¸ëŸ¼ìœ¼ë¡œ ìœ„ ì½”ë“œì—ì„œë„ Stringì´ ë³€í™˜ë˜ëŠ” ê³¼ì •ì—ì„œ ìƒê¸°ëŠ” ì„ì‹œ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ í™œìš©í•´ Heap ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ëŒ€ëµì ìœ¼ë¡œ ì•Œ ìˆ˜ ìˆì—ˆë˜ê²ƒì´ì£ .
ëŒ€ëµì ì¼ë¿ í™•ì‹¤í•˜ê³  ì •í™•í•œ ì£¼ì†Œì¸ì§€ëŠ” íŒë‹¨í•  ìˆ˜ ì—†ë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤.
 
ì¦‰, Stringì˜ ë°ì´í„°ê°€ ì‹¤ì œë¡œ ì €ì¥ëœ Heap ë©”ëª¨ë¦¬ ì£¼ì†Œì™€ëŠ” ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 
ê·¸ëŸ°ë° ì´ê²ƒë§Œìœ¼ë¡  ë‚©ë“í•˜ê¸°ì— ì¶©ë¶„í•˜ì§€ ì•Šì•˜ì–´ìš”!
ê°€ë”ì€ ë‹¤ë¥¸ ì£¼ì†Œë¥¼ ê°€ë¥´í‚¤ê²Œ ë‚˜ì˜¬ë•Œë„ ìˆê³  í° ë¬¸ìì—´ì´ ë“¤ì–´ê°€ë©´ í™•ì‹¤íˆ ë‹¤ë¥´ê²Œ ë‚˜íƒ€ë‚˜ë‹ˆê¹Œìš”!
 
ê·¸ë˜ì„œ ì˜¤ëŠ˜ ì£¼ì œì˜€ë˜ Small String Optimizationì´ë¼ëŠ” ê°œë… ë•Œë¬¸ì´ë¼ëŠ”ê²ƒì„ ì•Œ ìˆ˜ ìˆì—ˆì–´ìš” ğŸ˜ƒ
 
ê·¸ëŸ¼ Small String Optimizationì„ ì•Œì•„ë³¼ê¹Œìš”?

### String Optimization?

ìš°ì„  Stringì€ CoW (Copy-on-Write) ìµœì í™”ë¥¼ í†µí•´ ë©”ëª¨ë¦¬ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ í™ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.
ì´ëŠ” ë³€ìˆ˜ê°€ ë³µì‚¬ë  ë•Œ ì‹¤ì œ í™ ë°ì´í„°ê°€ ë³µì‚¬ë˜ëŠ”ê²ƒì´ ì•„ë‹ˆë¼ ì°¸ì¡° ì¹´ìš´íŠ¸ë§Œ ì¦ê°€í•˜ê³  ë°ì´í„°ê°€ ë³€ê²½ë  ë•Œ ì‹¤ì œë¡œ í™ ë©”ëª¨ë¦¬ì— ë°ì´í„°ê°€ ë³µì‚¬ë˜ëŠ” ë°©ì‹ì´ì£ !
 
ì—¬ê¸°ê¹Œì§€ëŠ” ì´ì „ í¬ìŠ¤íŒ…ì„ ë³´ì…¨ë‹¤ë©´ ì¶©ë¶„íˆ ì‰½ê²Œ ì•Œ ìˆ˜ ìˆëŠ” ì‚¬ì‹¤ì´ì£ .
 
ê·¸ëŸ¼ ì •ë§ì¸ì§€ í•œë²ˆ ì•„ë˜ ì½”ë“œë¥¼ í†µí•´ ëŒ€ëµì ì¸ Heap ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ì°ì–´ë³¼ê¹Œìš”?
 
```swift
import Foundation

var firstStr: String = "green"
var secondStr: String = firstStr

// MARK: - Stack ë©”ëª¨ë¦¬ ì˜ì—­ ì£¼ì†Œ ì¶œë ¥
func printStackAddress(input: inout String) {
  withUnsafePointer(to: &input) { pointer in
      print("The stack memory address is \(pointer)")
  }
}

// MARK: - Heap ë©”ëª¨ë¦¬ ì˜ì—­ ì£¼ì†Œ ì¶œë ¥
func printHeapAddress(address input: UnsafeRawPointer) {
    print(String(format: "The heap memory address is %p", Int(bitPattern: input)))
}

ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥
secondStr = "red"
ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥

printStackAddress(input: &firstStr)
printStackAddress(input: &secondStr)
printHeapAddress(address: firstStr)
printHeapAddress(address: secondStr)

// The stack memory address is 0x0000000100008018
// The stack memory address is 0x0000000100008028
// The heap memory address is 0x600000c04bc0
// The heap memory address is 0x600000c04bc0
```
 
ë¶„ëª… secondStrì€ firstStrì„ ë³µì‚¬í•˜ê³  ë‹¤ë¥¸ ë¬¸ìì—´ë¡œ ë°ì´í„°ë¥¼ ìˆ˜ì •í•´ì¤¬ìŠµë‹ˆë‹¤.
ê·¸ëŸ¼ ì˜ˆìƒë˜ëŠ” ê²°ê³¼ëŠ” ì„œë¡œ ë‹¤ë¥¸ Heap ì£¼ì†Œë¥¼ ë‚˜íƒ€ë‚´ì•¼ ë§ì„í…ë° ê°™ì€ ì£¼ì†Œë¥¼ ê°€ë¥´í‚¤ì£ !?
 
ê·¸ëŸ¼ CoWê°€ ì‚¬ì‹¤ì´ ì•„ë‹ˆì˜€ì–´..!?
 
ì•„ë‹™ë‹ˆë‹¤.
 
ì´ìœ ëŠ” Small String Optimizationë•Œë¬¸ì— ê·¸ë ‡ìŠµë‹ˆë‹¤.
 
Swiftì˜ Stringì€ ì‘ì€ ë¬¸ìì—´ì— ëŒ€í•´ì„œëŠ” Small String Optimizationì´ë¼ëŠ” ìµœì í™”ë¥¼ ìˆ˜í–‰í•´ìš”!
ì´ ìµœì í™”ë¼ëŠ”ê²ƒì€ ì‘ì€ ë¬¸ìì—´ (ê¸¸ì´ê°€ ì‘ì€)ì— ëŒ€í•´ Heap ë©”ëª¨ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡í•˜ë©´ì„œ String êµ¬ì¡°ì²´ ë‚´ì— ì§ì ‘ì ìœ¼ë¡œ ì €ì¥í•˜ë„ë¡ í•©ë‹ˆë‹¤.
ì´ìœ ëŠ” ì‘ì€ ë¬¸ìì—´ì˜ ìƒì„±ê³¼ ë³µì‚¬ì— ëŒ€í•œ ì˜¤ë²„í—¤ë“œë¥¼ ì¤„ì¼ ìˆ˜ ìˆëŠ” ì¥ì ë•Œë¬¸ì´ì£ .
 
ì¦‰, secondStrì´ ë³µì‚¬ë˜ê³  ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆì–´ë„ Heap ì£¼ì†ŒëŠ” ê°™ê²Œ ë‚˜ì˜¤ê²Œ ë˜ëŠ”ê²ƒì´ì£ .
ì‚¬ì‹¤ìƒ redê°€ String êµ¬ì¡°ì²´ ë‚´ì— ì§ì ‘ ì €ì¥ë˜ì–´ ìˆìœ¼ë‹ˆê¹Œìš”!
 
ê·¸ëŸ¼ ì‹¤ì œì¸ì§€ ë‘ ë¬¸ìì—´ì„ ë³µì‚¬í•˜ì§€ ì•Šê³  ë‹¤ë¥¸ ê°’ì„ ë„£ì–´ ì°ì–´ë³´ì£ !

```swift 
import Foundation

var firstStr: String = "green"
var secondStr: String = "red"

// MARK: - Stack ë©”ëª¨ë¦¬ ì˜ì—­ ì£¼ì†Œ ì¶œë ¥
func printStackAddress(input: inout String) {
  withUnsafePointer(to: &input) { pointer in
      print("The stack memory address is \(pointer)")
  }
}

// MARK: - Heap ë©”ëª¨ë¦¬ ì˜ì—­ ì£¼ì†Œ ì¶œë ¥
func printHeapAddress(address input: UnsafeRawPointer) {
    print(String(format: "The heap memory address is %p", Int(bitPattern: input)))
}

printStackAddress(input: &firstStr)
printStackAddress(input: &secondStr)
printHeapAddress(address: firstStr)
printHeapAddress(address: secondStr)

// The stack memory address is 0x0000000100008018
// The stack memory address is 0x0000000100008028
// The heap memory address is 0x600000c00200
// The heap memory address is 0x600000c00200
```
 
ë³µì‚¬ê°€ ì•„ë‹Œ ì•„ì˜ˆ ë‹¤ë¥¸ ë¬¸ìì—´ì„ ë„£ì–´ì¤˜ë„ ê¸¸ì´ê°€ ì§§ê¸°ì— String êµ¬ì¡°ì²´ ë‚´ì— ì €ì¥ë˜ì£ .
ê·¸ë¦¬ê³  ì„ì‹œ í™ ë©”ëª¨ë¦¬ ì£¼ì†Œê°€ ê°™ì€ê±¸ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 
ê·¸ëŸ°ë° ì—¬ê¸°ì„œ ì–´ë–¤ ë¬¸ìì—´ ë³€ìˆ˜ë¼ë„ ê¸¸ì´ê°€ ê¸´ í° ë¬¸ìì—´ë¡œ ë³€ê²½ë˜ë©´ ì´ ë¬¸ìì—´ì€ String êµ¬ì¡°ì²´ ë‚´ì— ì§ì ‘ ì €ì¥ë  ìˆ˜ ì—†ê¸°ì— ìƒˆë¡œìš´ Heap ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ í• ë‹¹ë°›ê²Œ ë©ë‹ˆë‹¤.
 
í•œë²ˆ ì½”ë“œë¡œ ë³¼ê¹Œìš”?
 
```swift
import Foundation

var firstStr: String = "greenredbluewhiteorangebrown"
var secondStr: String = firstStr

// MARK: - Stack ë©”ëª¨ë¦¬ ì˜ì—­ ì£¼ì†Œ ì¶œë ¥
func printStackAddress(input: inout String) {
  withUnsafePointer(to: &input) { pointer in
      print("The stack memory address is \(pointer)")
  }
}

// MARK: - Heap ë©”ëª¨ë¦¬ ì˜ì—­ ì£¼ì†Œ ì¶œë ¥
func printHeapAddress(address input: UnsafeRawPointer) {
    print(String(format: "The heap memory address is %p", Int(bitPattern: input)))
}

ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥
secondStr = "red"
ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥

printStackAddress(input: &firstStr)
printStackAddress(input: &secondStr)
printHeapAddress(address: firstStr)
printHeapAddress(address: secondStr)

// The stack memory address is 0x0000000100008018
// The stack memory address is 0x0000000100008028
// The heap memory address is 0x6000017080e0
// The heap memory address is 0x600000c08140
```
 
ì ë³´ì‹œë©´ secondStrì€ ê¸´ ë¬¸ìì—´ì¸ firsStrì„ ë³µì‚¬í•˜ê³  ê°’ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
ê²°ê³¼ë¥¼ ë³´ë©´ ì„œë¡œ ë‹¤ë¥¸ í™ ì£¼ì†Œë¥¼ ë‚˜íƒ€ë‚´ê³  ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆì£ !?
ì¦‰, ì‘ì€ ë¬¸ìì—´ì´ ë˜ë©° String êµ¬ì¡°ì²´ ë‚´ì— ì €ì¥ë˜ê²Œ ë˜ëŠ”ê²ƒì´ì£ .
 
### ë§ˆë¬´ë¦¬

ê²°ê³¼ì ìœ¼ë¡œ ì •ë¦¬í•´ë³´ë©´ ì´ë ‡ìŠµë‹ˆë‹¤!
Swiftì—ì„œëŠ” ì§ì ‘ì ìœ¼ë¡œ Heap ë©”ëª¨ë¦¬ ì£¼ì†Œì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
ê·¸ë ‡ê¸°ì— ìœ„ ì˜ˆì‹œ ì½”ë“œì—ì„œ ë³´ì—¬ì¤€ í™ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ì•Œì•„ë³´ëŠ” í•¨ìˆ˜ë“¤ì€ ëª…í™•í•˜ê²Œ ì •í™•í•œ ì£¼ì†Œë¼ê¸° ë³´ë‹¤ëŠ” String ì¸ìŠ¤í„´ìŠ¤ì˜ ì„ì‹œ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ì¶œë ¥í•˜ëŠ”ê²ƒì…ë‹ˆë‹¤.
ê·¸ë ‡ê¸°ì— 100% ì‹ ë¢°í•  ìˆ˜ ì—†ì„ ìˆ˜ ìˆì£ .
 
ê·¸ ë‹¤ìŒìœ¼ë¡œ ì‘ì€ ë¬¸ìì—´ì— ëŒ€í•´ì„œëŠ” Small String Optimizationì„ í†µí•´ String êµ¬ì¡°ì²´ ë‚´ì— ì €ì¥ë©ë‹ˆë‹¤.
 
### ë ˆí¼ëŸ°ìŠ¤

í•´ë‹¹ Swiftì—ì„œ Small String Optimizationì„ í™œìš©í•˜ëŠ”ê²ƒì€ ì•„ë˜ Swift ì˜¤í”ˆ ì†ŒìŠ¤ ì´ìŠˆì˜ ì •ë³´ë¡œë¶€í„° í•™ìŠµì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤ â˜ºï¸    
https://github.com/apple/swift/issues/46592    
https://green1229.tistory.com/417    
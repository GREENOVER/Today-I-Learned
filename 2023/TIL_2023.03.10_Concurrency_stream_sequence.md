## TIL (Today I Learned)

### 3ì›” 10ì¼ (ê¸ˆ)    

- ### [í•™ìŠµë‚´ìš©] Swift Concurrency - Async sequence & stream
    #### Sequences & Iterators
    ```swift
    struct RemoteDataSequence: Sequence {
        var urls: [URL]

        func makeIterator() -> RemoteDataIterator {
            RemoteDataIterator(urls: urls)
        }
    }
    ```
    ì¼ë ¨ì˜ URLì—ì„œ ë°ì´í„°ë¥¼ ë‹¤ìš´ë°›ì„ ìˆ˜ ìˆëŠ” ì‚¬ìš©ì ì§€ì • ì‹œí€€ìŠ¤ë¥¼ ìœ„ì²˜ëŸ¼ ë§Œë“ ë‹¤ê³  ìƒê°í•´ë³¼ê»˜ìš”.
    ë¨¼ì € Sequence í”„ë¡œí† ì½œì„ ë‹¹ì—°í•˜ê²Œ ì±„íƒí•´ì•¼ í•˜ê² ì£ ?
    ê·¸ ë‹¤ìŒ makeIteratorì´ë¼ëŠ” í•„ìˆ˜ ë©”ì„œë“œë¥¼ êµ¬í˜„í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

    ê·¸ëŸ¼ ì—¬ê¸°ì„œ íˆ­ íŠ€ì–´ë‚˜ì˜¨ RemoteDataIteratorì´ë¼ëŠ” íƒ€ì…ë„ ë§Œë“¤ì–´ ë³¼ê¹Œìš”?

    ```swift
    struct RemoteDataIterator: IteratorProtocol {
        var urls: [URL]
        fileprivate var index = 0

        mutating func next() -> Data? {
            guard index < urls.count else {
                return nil
            }

            let url = urls[index]
            index += 1

            // If a download fails, we simply move on to
            // the next URL in this case:
            guard let data = try? Data(contentsOf: url) else {
                return next()
            }

            return data
        }
    }
    ```
    ì´ë ‡ê²Œ IteratorProtocolì„ ì±„íƒí•˜ê³  next ë©”ì„œë“œë¥¼ í†µí•´ ìƒˆ ë°˜ë³µì„ ëŒë ¤ ì¤„ ìˆ˜ ìˆì–´ìš”.
    ì‹œìŠ¤í…œì—ì„œ ìƒˆ ìš”ì†Œê°€ ìš”ì²­ë  ë•Œ indexë¥¼ ì¦ê°€ì‹œí‚¤ëŠ” ë°©ë²•ì´ì£ .
    ìƒˆ for ë£¨í”„ê°€ ì‹œì‘ë  ë•Œ ë§ˆë‹¤ ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ìƒˆë¡œìš´ Iterator(ì‹œí€€ìŠ¤ì˜ makeIterator ë©”ì„œë“œë¥¼ ì´ìš©í•´)ë¥¼ ìƒì„±í•˜ê¸°ì— ì—¬ëŸ¬ë²ˆì˜ ë™ì‹œ ë°˜ë³µì„ ê´€ë¦¬í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤.
    ```swift
    for data in RemoteDataSequence(urls: urls) {
        ...
    }
    ```
    ì´ì œ ìœ„ ì‹œí€€ìŠ¤ êµ¬í˜„ì„ í†µí•´ ì´ë ‡ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ì»¤ìŠ¤í…€í•œ ì‹œí€€ìŠ¤ê°€ í•˜ë‚˜ ë§Œë“¤ì–´ì¡Œì–´ìš” ì§œì”!â­ï¸

    ê·¼ë° ìœ„ì²˜ëŸ¼ ëª¨ë“  ë°ì´í„°ë¥¼ ë™ê¸°ì ìœ¼ë¡œ ë‹¤ìš´ë°›ëŠ”ê±´ ì¢‹ì§€ ì•Šê² ì£ ? 
    ë™ì‹œì„±ê³¼ ë³‘ë ¬ì„ ì¤‘ìš”ì‹œí•˜ëŠ” Concurrency ì„¸ê³„ì—ì„œëŠ”..??
    ëª¨ë“  ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë  ë•Œ ê¹Œì§€ í˜„ì¬ ìŠ¤ë ˆë“œë¥¼ ì™„ì „íˆ ë§‰ì•„ë²„ë¦¬ê¸° ë•Œë¬¸ì—ë„ ë§ì´ì£ ã…ã…..

    ê·¸ë ‡ê¸°ì— ìš°ë¦¬ëŠ” ì´ê²ƒì„ ë¹„ë™ê¸° ì‹œí€€ìŠ¤ë¡œ ë³€ê²½í•´ë³¼ê»˜ìš”!

    #### ë¹„ë™ê¸°ì‹ ë°˜ë³µ

    ìš°ì„  ë°˜ë³µë¶€í„° ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆì–´ì•¼í•©ë‹ˆë‹¤.
    ìœ„ì—ì„œ êµ¬í˜„í•œ Iterator ë¶€ë¶„ ë§ì´ì£ .
    ```swift
    struct RemoteDataSequence: AsyncSequence {
        typealias Element = Data

        var urls: [URL]

        func makeAsyncIterator() -> RemoteDataIterator {
            RemoteDataIterator(urls: urls)
        }
    }
    ```
    Swift 5.5ì—ì„œëŠ” ìœ„ì—ì„œ ë³´ì‹œëŠ”ê²ƒì²˜ëŸ¼ AsyncSequenceë¼ëŠ” ê²ƒê³¼ ê°™ì´ ë¹„ë™ê¸° ì‹œí€€ìŠ¤ì™€ Iteratorì˜ ê°œë…ì„ ë„ì…í–ˆì–´ìš”.
    ê·¸ë ‡ê¸°ì— ë‹¨ìˆœí•˜ê²Œ ë¹„ë™ê¸°ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ìš°ì„  AsyncSequence ë¹„ë™ê¸° ì‹œí€€ìŠ¤ í”„ë¡œí† ì½œì„ ì±„íƒí•˜ê³  í•„ìˆ˜ ë©”ì„œë“œì¸ makeAsyncIteratorì„ êµ¬í˜„í•´ì¤ë‹ˆë‹¤.
    ì½”ë“œì—ì„œ ì“°ì¸ ElementëŠ” ì»´íŒŒì¼ëŸ¬ê°€ ì‹œí€€ìŠ¤ ìš”ì†Œ ìœ í˜•ì„ ì¶”ë¡ í•  ìˆ˜ ìˆì–´ì•¼ ë˜ê¸° ë•Œë¬¸ì— ì‹¤ì œë¡œ ì‚¬ìš©í•˜ì§„ ì•Šì§€ë§Œ ë„£ì–´ì¤¬ì–´ìš”.
    ê·¸ëŸ°ë° Xcode 13.0 ì´ìƒë¶€í„°ëŠ” ì˜ ì¶”ë¡ í•˜ëŠ”ê±¸ë¡œ ë³´ì…ë‹ˆë‹¤ğŸ™‹ğŸ»

    ê·¸ ë‹¤ìŒìœ¼ë¡œ, RemoteDataIteratorì— ë¹„ë™ê¸°ì‹ ì „í™˜ì„ êµ¬í˜„í•´ì¤ë‹ˆë‹¤.
    ```swift
    struct RemoteDataIterator: AsyncIteratorProtocol {
        var urls: [URL]
        fileprivate var urlSession = URLSession.shared
        fileprivate var index = 0

        mutating func next() async throws -> Data? {
            guard index < urls.count else {
                return nil
            }

            let url = urls[index]
            index += 1

            let (data, _) = try await urlSession.data(from: url)
            return data
        }
    }
    ```
    ASyncIteratorProtocolì„ ì±„íƒí•˜ê³  next ë©”ì„œë“œë¥¼ ë¹„ë™ê¸° ë©”ì„œë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤.
    ê·¸ëŸ°ë° ë°ì´í„° ë‹¤ìš´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŒìœ¼ë¡œ throwsë¥¼ ë¶™ì—¬ì¤ë‹ˆë‹¤.
    ë§ˆì§€ë§‰ìœ¼ë¡œ urlSession ë¶€ë¶„ì—ì„œ ë„¤íŠ¸ì›Œí‚¹í•˜ëŠ” ìª½ì´ê¸°ì— ë°ì´í„°ë¥¼ ì™„ì „íˆ ë¹„ë™ê¸°ì‹ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ í•  ìˆ˜ ìˆë„ë¡ ì²˜ë¦¬í•´ì¤ë‹ˆë‹¤.

    ì ì´ì œ ì ìš©í•´ë³¼ê¹Œìš”?
    ```swift
    for try await data in RemoteDataSequence(urls: urls) {
        ...
    }
    ```
    for try await êµ¬ë¬¸ì„ í†µí•´ ì ìš©í•˜ë©´ ë!
    ì´ë ‡ê²Œ ëœë‹¤ë©´ ë°ì´í„°ê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë‹¤ìš´ë¡œë“œë˜ê³  ì¤€ë¹„ê°€ ì™„ë£Œë˜ë©´ ë£¨í”„ì— ì „ë‹¬ë©ë‹ˆë‹¤.
    ì—¬ê¸°ì„œ ì˜¤ë¥˜ê°€ ë‚˜ë©´ ìë™ìœ¼ë¡œ for ë£¨í”„ë¥¼ ë²—ì–´ë‚ ê²ƒì´ê¸°ì— ë™ê¸°í™”ì—ì„œë„ ì•„ì£¼ ìœ ìš©í•©ë‹ˆë‹¤.
    ë¬¼ë¡  ëª¨ë“  ë¹„ë™ê¸° ì‹œí€€ìŠ¤ê°€ throwsë¥¼ ë¶™ì—¬ì¤˜ ì´ëŸ° ë™ì‘ì„ í•´ì¤˜ì•¼í•˜ì§„ ì•ŠìŠµë‹ˆë‹¤.
    í™•ì‹¤íˆ í•„ìš”ì—†ë‹¤ë©´ ì•ˆì“°ëŠ”ê²Œ ë” ì¢‹ì£  ì‚¬ì‹¤!

    ì, ê·¸ ë‹¤ìŒìœ¼ë¡œ ì´ì œ ë¹„ë™ê¸° ìŠ¤íŠ¸ë¦¼ì— ëŒ€í•´ ì•Œì•„ë³´ì‹œì£ ğŸ™Œ

    #### ë¹„ë™ê¸° ìŠ¤íŠ¸ë¦¼

    AsyncStreamê³¼ AsyncThrowingStreamì´ë¼ëŠ” ìœ í˜•ì„ í†µí•´ ìš°ë¦¬ëŠ” ì™„ì „í•œ ë¹„ë™ê¸° ìŠ¤íŠ¸ë¦¼ì„ êµ¬í˜„í•´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ```swift
    func remoteDataStream(
        forURLs urls: [URL],
        urlSession: URLSession = .shared
    ) -> AsyncThrowingStream<Data, Error> {
        AsyncThrowingStream { continuation in
            Task {
                do {
                    for url in urls {
                        let (data, _) = try await urlSession.data(from: url)
                        continuation.yield(data)
                    }

                    continuation.finish(throwing: nil)
                } catch {
                    continuation.finish(throwing: error)
                }
            }
        }
    }
    ```
    ìœ„ ì½”ë“œì²˜ëŸ¼ AsynThrowingStream íƒ€ì…ìœ¼ë¡œ ì§€ì •í•©ë‹ˆë‹¤.
    ë‚´ë¶€ë¥¼ ê°ì‹¸ëŠ”ë° continuation ë³´ì´ì‹œì£ ?
    ìš°ë¦¬ê°€ Combineì—ì„œë„ publisherë¥¼ sendí•˜ì—¬ ë°ì´í„°ë¥¼ ë³´ë‚´ê±°ë‚˜ completeì‹œí‚¤ê±°ë‚˜ í–ˆìŠµë‹ˆë‹¤.
    ì´ê²ƒì²˜ëŸ¼ ì‚¬ìš©ë  ì¹œêµ¬ì—ìš”!
    urlsë¥¼ ë°˜ë³µí•˜ë©° ë°ì´í„°ë¥¼ í†µì‹ í•˜ì—¬ ë¶ˆëŸ¬ì˜¤ê³  í•˜ë‚˜ì”© ë“¤ì–´ì˜¬ë•Œë§ˆë‹¤ ë°ì´í„°ë¥¼ yieldë¥¼ í†µí•´ ë‹´ì•„ ë³´ë‚´ì¤ë‹ˆë‹¤.
    ê·¸ëŸ¼ ëª¨ë“ ê±¸ ê¸°ë‹¤ë ¸ë‹¤ ë³´ë‚´ëŠ”ê²Œ ì•„ë‹Œ í•˜ë‚˜ì”© ë“¤ì–´ì˜¤ëŠ”ê±¸ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ë°©ì¶œí•´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ì™„ë£Œê°€ ë˜ì—ˆë‹¤ë©´ finishë¡œ ì´ì£¼ëŠ”ë° ì—ëŸ¬ê°€ ì—†ìœ¼ë‹ˆ nilì„ ë„£ì–´ì¤ë‹ˆë‹¤.
    ë§Œì•½ catchì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ì—¬ ê±¸ë¦¬ë©´ finishì— errorë¥¼ ë‹´ì•„ ë˜ì ¸ì¤ë‹ˆë‹¤.

    ì´ëŸ¬í•œ êµ¬í˜„ì„ ì¡°ê¸ˆ ë” ê°„í¸í•˜ê²Œ ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.
    ```swift
    func remoteDataStream(
        forURLs urls: [URL],
        urlSession: URLSession = .shared
    ) -> AsyncThrowingStream<Data, Error> {
        var index = 0

        return AsyncThrowingStream {
            guard index < urls.count else {
                return nil
            }

            let url = urls[index]
            index += 1

            let (data, _) = try await urlSession.data(from: url)
            return data
        }
    }
    ```
    ë³´ì‹œë©´ continuationìœ¼ë¡œ yieldí•˜ê±°ë‚˜ finishí•˜ëŠ” ë¶€ë¶„ì€ ìƒëµë˜ìˆê³  ë§ˆì§€ë§‰ì— dataë§Œ ë°˜í™˜í•´ì¤ë‹ˆë‹¤.
    ë‹¤ë§Œ ë°˜ë³µ ìƒíƒœë¥¼ ì¶”ì í•˜ê¸° ìœ„í•´ index ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

    ì´ëŸ¬í•œ êµ¬í˜„ì„ í†µí•´ ì‹¤ì œë¡  ì•„ë˜ì²˜ëŸ¼ ë¹„ë™ê¸° ìŠ¤íŠ¸ë¦¼ì„ í˜¸ì¶œí•´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ```swift
    for try await data in remoteDataStream(forURLs: urls) {
        ...
    }
    ```

    ì ì´ì œ ì´ê²ƒë“¤ì´ Combineê³¼ ì–´ë–¤ ê´€ë ¨ì´ ìˆì„ê¹Œìš”?

    #### Combineê³¼ì˜ ì—°ê´€ì„±

    Combineì„ ì‚¬ìš©í•˜ì‹ ë¶„ì´ë¼ë©´ ì•„ì‹œê² ì§€ë§Œ ì‹œê°„ íë¦„ì— ë”°ë¼ ê°’ì„ ë°©ì¶œí•˜ê³  ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ì´ëŸ¬í•œ ê°œë…ê³¼ ìœ„ì—ì„œ ë‹¤ë£¬ Swift Concurrencyì˜ ë¹„ë™ê¸° ìŠ¤íŠ¸ë¦¼ì˜ ì—°ê´€ì„ ì§€ì–´ë³´ì£ .
    ê·¸ëŸ°ë° ì§šê³  ë„˜ì–´ê°€ì•¼í• ê±´ ë¶„ëª… Combine ìì²´ë„ ì¶©ë¶„íˆ ê´œì°®ê³  Swift Concurrencyë¼ê³ í•´ì„œ ë” ì™„ë²½í•˜ë‹¤ ì´ëŸ°ê±´ ì „í˜€ ì•„ë‹™ë‹ˆë‹¤.
    ì¥ì ìœ¼ë¡œ ë“¤ê³ ê°ˆê±´ ë¹„ë™ê¸° ì‹œí€€ìŠ¤ë¥¼ êµ¬ì„±í•˜ê¸° ìœ„í•œ ê³µìˆ˜ì— ë” ë‚®ì€ ìˆ˜ì¤€ì˜ APIë¥¼ ì œê³µí•´ì£¼ê¸°ì— ì¡°ê¸ˆ ë” ì‚¬ìš©ì´ ì‰½ë‹¤ëŠ”ê²ƒì´ì£ .

    ì, ê·¸ëŸ¼ ë§Œì•½ ì—¬ëŸ¬ë¶„ë“¤ì˜ ê¸°ì¡´ ì½”ë“œê°€ ë‹¤ Combineìœ¼ë¡œ ì‘ì—…ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•´ë´…ì‹œë‹¤.
    ê·¸ëŸ´ë•Œ Swift Concurrencyë¥¼ ë„ì…í•˜ê³  ì‹¶ë‹¤ë©´ ì–´ë–»ê²Œ ë³€í™˜í•  ìˆ˜ ìˆì„ê¹Œìš”?

    Combineì´ ì´ì œëŠ” ì™„ì „íˆ í˜¸í™˜ë˜ê¸°ì— ì–´ë–¤ ê°’ì´ë“  AsyncSequenceë¡œ ë³€í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ```swift
    func remoteDataPublisher(
        forURLs urls: [URL],
        urlSession: URLSession = .shared
    ) -> AnyPublisher<Data, URLError> {
        urls.publisher
            .setFailureType(to: URLError.self)
            .flatMap(maxPublishers: .max(1)) {
                urlSession.dataTaskPublisher(for: $0)
            }
            .map(\.data)
            .eraseToAnyPublisher()
    }
    ```
    ë³´ì‹œë©´ ê¸°ì¡´ ìµìˆ™í•œ AnyPublisherë¥¼ ë°˜í™˜í•˜ëŠ” Combine ì½”ë“œê°€ ìˆìŠµë‹ˆë‹¤.
    ìœ„ ë©”ì„œë“œê°€ ë°˜í™˜í•˜ëŠ” AnyPublisherë¥¼ ë‹¨ìˆœíˆ AsyncSequenceë¡œ ë³€í™˜í•˜ë ¤ë©´ ê°’ ì†ì„±ì— ì ‘ê·¼í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.
    ë‚˜ë¨¸ì§€ëŠ” ì‹œìŠ¤í…œì´ ë‹¤ ì•Œì•„ì„œ ì²˜ë¦¬í•´ì¤ë‹ˆë‹¤ğŸ‘
    ```swift
    let publisher = remoteDataPublisher(forURLs: urls)

    for try await data in publisher.values {
        ...
    }
    ```
    ì§œì”~~
    ë§¤ìš° ê¹”ë”í•´ì¡Œì£ ?
    ë‹¨ìˆœíˆ ê°’ ì†ì„±ì¸ valuesë¡œ ì ‘ê·¼ë§Œí•˜ë©´ AsyncSequenceë¡œ ë³€í™˜ë˜ì–´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ê·¸ë ‡ê¸°ì— ê¸°ì¡´ Combine ì½”ë“œë„ ì´ë ‡ê²Œ ë¶™ì—¬ì£¼ì–´ Swift Concurrencyì˜ ë¹„ë™ê¸° ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ë³€í™˜í•´ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆì£ !

    #### ê²°ë¡ 

    AsyncStreamê³¼ AsyncSequenceë¥¼ ê¸°ì¡´ Combineê³¼ ì˜ í˜¼í•©í•´ë´ìš”ğŸ™Œ

    #### ë§ˆë¬´ë¦¬

    ê·¸ì € ê°“.... valuesë¡œ ê°’ ì†ì„±ë§Œ ì—‘ì„¸ìŠ¤ í•´ì£¼ë©´ ë³€í•œë‹¤ë‹ˆ..
    ì• í”Œ ê°“ì…ë‹ˆë‹¤.

    #### [ì°¸ê³  ìë£Œ]
    https://green1229.tistory.com/338
    https://www.swiftbysundell.com/articles/async-sequences-streams-and-combine/
## TIL (Today I Learned)

### 2ì›” 13ì¼ (ì›”)    

- ### [í•™ìŠµë‚´ìš©] Get ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì‹¬í”Œí•œ ì›¹ API í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„í•˜ê¸°
    #### ìš°ë¦¬ê°€ ìµìˆ™í•˜ê²Œ ì•Œê³  ìˆëŠ” ë„¤íŠ¸ì›Œí¬ í†µì‹ 

    ë‹¹ì—°í•œ ë§ì´ì§€ë§Œ í´ë¼ì´ì–¸íŠ¸ ê°œë°œì„ í•˜ë©´ì„œ API ë„¤íŠ¸ì›Œí¬ í†µì‹ ì€ ì•ˆí• ë˜ì•¼ ì•ˆí• ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.
    ë„¤íŠ¸ì›Œí¬ í†µì‹ ì„ ìœ„í•´ ìš°ë¦¬ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì• í”Œì—ì„œ ì œê³µí•´ì£¼ëŠ” URLSessionì„ ì‚¬ìš©í•˜ê¸°ë„ í•˜ê³  Alamofireë‚˜ Moyaì™€ ê°™ì€ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ë„ì›€ì„ ë°›ì•„ URLSessionì„ ì¶”ìƒí™”í•˜ì—¬ ì¡°ê¸ˆ ë” ì‰½ê²Œ ì‚¬ìš©í•˜ê¸°ë„ í•©ë‹ˆë‹¤.
    ì ê·¸ëŸ¼ ì—¬ê¸°ë‹¤ í•˜ë‚˜ë¥¼ ë” ì¶”ê°€í•´ì„œ ì•Œì•„ë³´ë ¤ê³  í•©ë‹ˆë‹¤.
    ê·¸ê²Œ ë°”ë¡œ ì˜¤ëŠ˜ í•´ë³¼ Getì´ë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤.

    êµ¬êµ¬ì ˆì ˆ ìì„¸í•œ Getì— ëŒ€í•´ íŒŒí•´ì³ë³´ì‹œì£ !

    #### Get ë¼ì´ë¸ŒëŸ¬ë¦¬ë€?

    Getì´ë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” async/awaitë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ì¶•ëœ ê°„ê²°í•œ Swift ì›¹ API í´ë¼ì´ì–¸íŠ¸ì…ë‹ˆë‹¤.
    ì¦‰ Getì€ Request<Response>ì˜ íƒ€ì…ì„ ì‚¬ìš©í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ëª¨ë¸ë§í•˜ê¸° ìœ„í•œ ëª…í™•í•˜ê³  í¸ë¦¬í•œ APIë¥¼ ì œê³µí•©ë‹ˆë‹¤.
    ì•„ë˜ì™€ ê°™ì´ ê°„í¸í•˜ê²Œ êµ¬ì„±í•´ì„œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ í•´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ```swift
    // Create a client
    let client = APIClient(baseURL: URL(string: "https://api.github.com"))

    // ìš”ì²­ ê°’ ì €ì¥
    let user: User = try await client.send(Request(path: "/user")).value

    // ìš”ì²­
    var request = Request(path: "/user/emails", method: .post, body: ["alex@me.com"]
    try await client.send(request)
    ```
    ë³´ì‹œë©´ ì•„ì£¼ ê°„ë‹¨í•˜ê²Œ APIClient íƒ€ì…ì˜ ìƒìˆ˜ë¥¼ ë§Œë“¤ì–´ awaitë¡œ ìš”ì²­ì„ ë„£ìœ¼ë©´ ëì…ë‹ˆë‹¤.

    ê·¸ëŸ¼ ì—¬ê¸°ì„œ í•˜ë‚˜ì”© ì²œì²œíˆ ì§šì–´ë³´ë ¤í•´ìš”.
    ìš°ì„  APIClientì˜ êµ¬ì„±ì´ ì–´ë–»ê²Œ ë˜ì–´ ìˆê³  ì–´ë–¤ íŒŒë¼ë¯¸í„°ë“¤ì„ ë„£ì–´ì¤„ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•´ë³´ì‹œì£ !
    (swift 5.7 ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.)

    #### APIClient ë§Œë“¤ê¸°
    ```swift
    public actor APIClient {
        /// The configuration with which the client was initialized with.
        public nonisolated let configuration: Configuration
        /// The underlying `URLSession` instance.
        public nonisolated let session: URLSession

        private let decoder: JSONDecoder
        private let encoder: JSONEncoder
        private let delegate: APIClientDelegate
        private let dataLoader = DataLoader()

        /// The configuration for ``APIClient``.
        public struct Configuration: @unchecked Sendable {
            /// A base URL. For example, `"https://api.github.com"`.
            public var baseURL: URL?
            /// The client delegate. The client holds a strong reference to it.
            public var delegate: APIClientDelegate?
            /// By default, `URLSessionConfiguration.default`.
            public var sessionConfiguration: URLSessionConfiguration = .default
            /// The (optional) URLSession delegate that allows you to monitor the underlying URLSession.
            public var sessionDelegate: URLSessionDelegate?
            /// Overrides the default delegate queue.
            public var sessionDelegateQueue: OperationQueue?
            /// By default, uses `.iso8601` date decoding strategy.
            public var decoder: JSONDecoder
            /// By default, uses `.iso8601` date encoding strategy.
            public var encoder: JSONEncoder

            /// Initializes the configuration.
            public init(
                baseURL: URL?,
                sessionConfiguration: URLSessionConfiguration = .default,
                delegate: APIClientDelegate? = nil
            ) {
                self.baseURL = baseURL
                self.sessionConfiguration = sessionConfiguration
                self.delegate = delegate
                self.decoder = JSONDecoder()
                self.decoder.dateDecodingStrategy = .iso8601
                self.encoder = JSONEncoder()
                self.encoder.dateEncodingStrategy = .iso8601
            }
        }

        // MARK: Initializers
        public init(baseURL: URL?, _ configure: @Sendable (inout APIClient.Configuration) -> Void = { _ in }) {
            var configuration = Configuration(baseURL: baseURL)
            configure(&configuration)
            self.init(configuration: configuration)
        }
    }
    ```
    ë³´ì‹œë©´ Configurationì— ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ìœ„í•œ baseURLê³¼ APIClientDelegate íƒ€ì…ì˜ í”„ë¡œí¼í‹° ë“± ë„¤íŠ¸ì›Œí‚¹ì˜ ì„¤ì •ë“¤ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.
    ê·¸ë¦¬ê³  ë””ì½”ë”/ì¸ì½”ë”ë„ ê¸°ë³¸ì ìœ¼ë¡œ ì •ì˜ë˜ì–´ ìˆê¸°ì— ìš°ë¦¬ê°€ ìœ ì‹¬íˆ ë´ë³¼ ë¶€ë¶„ì€ baseURLê³¼ Configuration íƒ€ì…ì„ êµ¬ì„±í•˜ëŠ”ê²ƒì— ì´ˆì ì„ ë§ì¶”ë©´ ë©ë‹ˆë‹¤.
    ì²˜ìŒ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“¤ê³  ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ í•˜ëŠ” ì˜ˆì œë¥¼ ë³´ë©´ baseURLì€ í•„ìˆ˜ë¡œ ë„£ì–´ì£¼ê³  Configurationì€ ë””í´íŠ¸ ê°’ìœ¼ë¡œ ê°€ì ¸ê°”ì–´ìš”.
    ê¸°ë³¸ HTTP methodëŠ” getìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆê¸°ì— ì €ë ‡ê²Œë§Œìœ¼ë¡œë„ ê°€ëŠ¥í•œê²ƒì´ì£ .
    ìš°ì„  ì´ë ‡ê²Œ APIClientë¥¼ ë§Œë“ ë‹¤ëŠ”ê²ƒì„ ì¸ì§€í•˜ë©´ ë©ë‹ˆë‹¤.

    ê·¸ ë‹¤ìŒìœ¼ë¡œ ì‚´ì§ ì§šê³  ë„˜ì–´ê°€ë³¼ê²ƒì´ Configurationì—ì„œ delegateë‚˜ sessionDelegateë“±ê³¼ ê°™ì€ í”„ë¡œí† ì½œ íƒ€ì…ì„ ë””í´íŠ¸ê°€ ì•„ë‹Œ ë³„ë„ ì»¤ìŠ¤í…€í•˜ê²Œ êµ¬í˜„í•´ì¤€ë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ ì‹¬ì–´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ```swift
    let client = APIClient(baseURL: URL(string: "https://api.github.com")) {
        $0.delegate = NetworkManagerDelegate()
        $0.sessionDelegate = delegate
        ...
    }

    // Set APIClientDelegate
    final class NetworkManagerDelegate: APIClientDelegate {
      let decoder = JSONDecoder()

      func client(_ client: APIClient, willSendRequest request: inout URLRequest) async throws {
        AuthManager.shouldRetry = false
        // AUTH
        if let urlString = request.url?.absoluteString,
           isAccessTokenNeedPath(from: urlString) // ì•¡ì„¸ìŠ¤ í† í° í•„ìˆ˜ APIì¸ ê²½ìš°
        {
          let accessToken = Defaults[.accessToken]
          let newAccessToken = accessToken.replacingOccurrences(of: "bearer", with: "")
            .trimmingCharacters(in: .whitespaces)

          let refreshToken = Defaults[.refreshToken]
          let newRefreshToken = refreshToken.replacingOccurrences(of: "bearer", with: "")
            .trimmingCharacters(in: .whitespaces)

          if !newAccessToken.isEmpty {
            request.setValue("bearer \(newAccessToken)", forHTTPHeaderField: "Authorization")
          }

          if !newRefreshToken.isEmpty {
            request.setValue("bearer \(newRefreshToken)", forHTTPHeaderField: "refreshToken")
          }
        }
      }
      ...
    }

    // Set URLSessionDataDelegate
    let delegate: URLSessionDataDelegate = ...
    ```
    ì´ëŸ°ì‹ìœ¼ë¡œ í”„ë¡œí† ì½œì„ ì±„íƒí•œ íƒ€ì…ì„ ë§Œë“¤ë©´ì„œ ë‚´ë¶€ í•„ìˆ˜ êµ¬í˜„ë“¤ì„ ì»¤ìŠ¤í…€í•˜ê²Œ êµ¬í˜„í•˜ê³  ì´ê±¸ APIClient ì„¤ì • ê°’ìœ¼ë¡œ ë¶€ì—¬í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    ê·¸ ë‹¤ìŒìœ¼ë¡œ ì‹¤ì œ ë§Œë“¤ì–´ì§„ APIClientë¥¼ í†µí•´ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.

    #### send ë©”ì„œë“œë¡œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­í•˜ê¸°

    APIClient actor êµ¬í˜„ì²´ë¥¼ ëœ¯ì–´ë³´ë©´ ë‹¤ì–‘í•˜ê²Œ ìˆëŠ”ë° ê·¸ ì¤‘ sendë¼ëŠ” ë©”ì„œë“œê°€ ë‚´ì¥ë˜ì–´ ìˆì–´ìš”.
    ```swift
    public actor APIClient {
        @discardableResult public func send<T: Decodable>(
            _ request: Request<T>,
            delegate: URLSessionDataDelegate? = nil,
            configure: ((inout URLRequest) throws -> Void)? = nil
        ) async throws -> Response<T> {
            let response = try await data(for: request, delegate: delegate, configure: configure)
            let decoder = self.delegate.client(self, decoderForRequest: request) ?? self.decoder
            let value: T = try await decode(response.data, using: decoder)
            return response.map { _ in value }
        }
        ...
    }
    ```
    ë³´ì‹œë©´ Request<T> íƒ€ì…ì„ ë°›ëŠ”ë° ì—¬ê¸°ì„œ T ì œë„¤ë¦­ì—ëŠ” ë””ì½”ë”© ê°€ëŠ¥í•œ íƒ€ì…ì„ ë„£ì–´ì¤˜ì•¼í•©ë‹ˆë‹¤.
    ê·¸ë¦¬ê³  APIClientì™€ ë¹„ìŠ·í•˜ê²Œ delegateë‚˜ configureì„ ì»¤ìŠ¤í…€í•´ì¤„ ìˆ˜ ìˆì–´ìš”.
    ì¦‰ í•„ìˆ˜ë¡œ Requestë¥¼ ë§Œë“¤ì–´ ë„£ì–´ì¤€ë‹¤! ë¼ê³  ì´í•´í•˜ê³  ê°€ì‹œì£ ğŸ•ºğŸ»
    ì°¸ê³ ë¡œ APIClient êµ¬í˜„ì²´ì—ëŠ” sendë¿ ì•„ë‹ˆë¼ data, download, upload ë“± ë‹¤ì–‘í•œ ë©”ì„œë“œë“¤ì´ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë‹ˆ ìƒí™©ì— ë§ê²Œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤!ğŸ™ğŸ»

    ì—¬ê¸°ì„œ Request êµ¬í˜„ì²´ë¥¼ ëœ¯ì–´ë³¼ê»˜ìš”.
    ```swift
    public struct Request<Response>: @unchecked Sendable {
        public var method: HTTPMethod
        public var url: URL?
        public var query: [(String, String?)]?
        public var body: Encodable?
        public var headers: [String: String]?
        public var id: String?

        // Use URL
        public init(
            url: URL,
            method: HTTPMethod = .get,
            query: [(String, String?)]? = nil,
            body: Encodable? = nil,
            headers: [String: String]? = nil,
            id: String? = nil
        ) {
            self.method = method
            self.url = url
            self.query = query
            self.headers = headers
            self.body = body
            self.id = id
        }

        // Use Path
        public init(
            path: String,
            method: HTTPMethod = .get,
            query: [(String, String?)]? = nil,
            body: Encodable? = nil,
            headers: [String: String]? = nil,
            id: String? = nil
        ) {
            self.method = method
            self.url = URL(string: path.isEmpty ? "/" : path)
            self.query = query
            self.headers = headers
            self.body = body
            self.id = id
        }
    }
    ```
    ë³´ì‹œë©´ ê¸°ë³¸ì ì¸ Request ìƒì„± ì‹œ Response íƒ€ì…ì„ ì œë„¤ë¦­í•˜ê²Œ ë°›ìŠµë‹ˆë‹¤.
    ì¦‰ ìš”ì²­í•œ ê²°ê³¼ ë¦¬ìŠ¤í°ìŠ¤ì— ëŒ€í•´ íƒ€ì… ë§¤ì¹­ì„ ì‹œì¼œì£¼ëŠ”ê²ƒì´ì£ .
    í•„ìš”í•œ ê°’ìœ¼ë¡œëŠ” ë³´ì‹œëŠ”ê²ƒì²˜ëŸ¼ method, url, query, body, headers, id ë“± í†µì‹ ì— í•„ìš”í•œê²ƒì´ ìˆì–´ìš”.
    ì´ë‹ˆì…œë¼ì´ì €ì—ì„œëŠ” ë³´ë©´ ë‘ê°€ì§€ íƒ€ì…ì´ ìˆëŠ”ë° URLë¡œ ìš”ì²­í•˜ëŠëƒ ì•„ë‹ˆë©´ ê¸°ì¡´ clientì˜ baseURLì—ì„œì˜ pathë¡œ ì´ìš©í•˜ëŠëƒ ì…ë‹ˆë‹¤.

    ê·¸ëŸ¼ ê°„ëµíˆ êµ¬í˜„ì„ í•´ë³´ë©´ì„œ ë³´ì‹œì£ !
    ```swift
    // ë„¤íŠ¸ì›Œí¬ ë§¤ë‹ˆì € ìƒì„±
    public struct NetworkManager {
      public let client: APIClient

      public init(baseURL: String) {
        self.client = APIClient(baseURL: URL(string: baseURL)) {
          $0.delegate = NetworkManagerDelegate()
          ...
        }
      }
    }

    // í•´ë‹¹ API ìƒì„±
    enum GreenAPI {
      private static let manager = NetworkManager(baseURL: "https://green.com")
    }

    // Endpoint êµ¬í˜„
    enum GreenEndpoint {
      case getGreenInfo

      var path: String {
        switch self {
        case .getGreenInfo: return "/info"
        }
      }
    }

    // ë„¤íŠ¸ì›Œí¬ í†µì‹  ì¢…ë¥˜ë³„ ë©”ì„œë“œ êµ¬í˜„
    extension GreenAPI {
      /// ê·¸ë¦° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      static func getGreenInfo() async throws -> Response<GreenModel> {
        let request: Request<GreenModel> = Request(
          path: GreenEndpoint.getGreenInfo.path,
          method: .get
        )
        return try await manager.client.send(request)
      }
      ...
    }
    ```
    ìš°ì„  ì¤‘ë³µì´ê¸´ í•˜ì§€ë§Œ ë„¤íŠ¸ì›Œí¬ ë§¤ë‹ˆì €ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    ê·¸ ë‹¤ìŒ ê° API ë„ë©”ì¸ì—ì„œ ì €ëŠ” GreenAPIë¥¼ ë§Œë“¤ì–´ë³¼ê»˜ìš”.
    GreenAPI ì—´ê±° íƒ€ì… ë‚´ë¶€ staticí•˜ê²Œ ë„¤íŠ¸ì›Œí¬ ë§¤ë‹ˆì € í”„ë¡œí¼í‹°ë¥¼ baseURLê³¼ í•¨ê»˜ ìƒì„±í•´ì¤ë‹ˆë‹¤.
    ê·¸ í›„ ê° ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ê°€ì§ˆ Endpointë¥¼ case ë³„ë¡œ ì •ë¦¬í•˜ê³  pathë¥¼ ì§€ì •í•´ì¤ë‹ˆë‹¤.
    ë§ˆì§€ë§‰ìœ¼ë¡œ ê¸°ì¡´ GreenAPIë¥¼ í™•ì¥ì‹œì¼œ í†µì‹  ë©”ì„œë“œ êµ¬í˜„ì²´ë¥¼ êµ¬í˜„í•´ì£¼ë©´ë©ë‹ˆë‹¤.
    ì˜ˆë¥¼ë“¤ì–´ ì €ì²˜ëŸ¼ ê·¸ë¦° ì •ë³´ ê°€ì ¸ì˜¤ê¸° ê¸°ëŠ¥ì„ í•´ì¤„ ìˆ˜ ìˆë„ë¡ ë§Œë“ ë‹¤ë©´ í•´ë‹¹ í†µì‹  í›„ ë¦¬ìŠ¤í°ìŠ¤ íƒ€ì…ì„ ë°˜í™˜í•˜ë„ë¡ êµ¬ì„±í•˜ê³  ë‚´ë¶€ì—ì„œëŠ” requestë¥¼ ë§Œë“œëŠ” ê²ƒì´ì£ ğŸ™Œ
    pathë¥¼ ì§€ì •í•˜ê³  HTTP methodë¥¼ ì§€ì •í•œ í›„ í•´ë‹¹ requestë¥¼ send ë©”ì„œë“œë¥¼ í†µí•´ ë‹´ì•„ í†µì‹ ì‹œì¼œì£¼ë©´ ë©ë‹ˆë‹¤.

    ê·¸ëŸ¼ í†µì‹  ì‹œì¼œë³¼ê¹Œìš”?

    MVVM ëŠë‚Œìœ¼ë¡œ ê°€ì •í•˜ê³  ViewModelì—ì„œ ì²˜ë¦¬í•´ë³¼ê»˜ìš”.
    ```swift
    final class GreenViewModel: ObservableObject {
      @Published var greenAge: Int = 7
      ...

      @MainActor
      func getGreenInfo() async throws {
        let response = try await GreenAPI.getGreenInfo

        // ë°ì´í„° ë°”ì¸ë”© ë° ì²˜ë¦¬
        greenAge = response.value.age
        ...
      }
    }
    ```
    ìš”ëŸ°ì‹ìœ¼ë¡œê°„ë‹¨íˆ í†µì‹ ì‹œí‚¤ê³  í•´ë‹¹ valueì—ì„œ ì›í•˜ëŠ” ê°’ì„ ë§¤ì¹­í•´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    #### ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì‹œ ë‹¤ì–‘í•œ ë¶€ê°€ ê¸°ëŠ¥ í•´ì£¼ê¸°

    ìœ„ì—ì„œ ë´¤ë˜ ê¸°ë³¸ì ì¸ ë¹ ë¥¸ ìš”ì²­ ì™¸ì—ë„ ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ/ì—…ë¡œë“œ í•˜ê±°ë‚˜ ì¸ì¦ ë° ì¬ì‹œë„, ë¡œê¹… ë“±ì„ ì§€ì›í•´ì£¼ëŠ” ì—­í• ë„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ì´ê²ƒë“¤ì€ send ìš”ì²­ ì‹œ í´ë¡œì € ì¸ìë¡œ ë‹´ì•„ ì²˜ë¦¬í•´ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ```swift
    let delegate: URLSessionDataDelegate = ...
    let response = try await client.send(Paths.user.get, delegate: delegate) {
      // ìºì‹œ ì •ì±… ì„¤ì •
      $0.cachePolicy = .reloadIgnoringLocalCacheData
    }
    ```

    #### ë§ˆë¬´ë¦¬

    ë­”ê°€ ì½”ë“œë¥¼ ì¢€ ê¹Œë³´ë©´ì„œ ë´¤ê¸°ì— ì¤‘êµ¬ë‚œë°©ì´ ë  ìˆ˜ ìˆì—ˆë˜ ì±•í„° ê°™ì•„ìš”ğŸ¥²
    ì˜ëª»ëœ ë¶€ë¶„ì´ë‚˜ ë¹ ì§„ ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì¡°ì–¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤ğŸ™ğŸ»

    #### [ì°¸ê³  ìë£Œ]
    https://green1229.tistory.com/329   
    https://github.com/kean/Get

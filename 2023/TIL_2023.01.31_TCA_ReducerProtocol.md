## TIL (Today I Learned)

### 1ì›” 31ì¼ (í™”)    

- ### [í•™ìŠµë‚´ìš©] TCA - ReducerProtocol
    #### ReducerProtocol?

    ìš°ì„  Pointfree ê³µì‹ë¬¸ì„œì— ë”°ë¥´ë©´ ì•±ì—ì„œ ì•¡ì…˜ì´ ì£¼ì–´ì§ˆë•Œ í˜„ì¬ ìƒíƒœì—ì„œ ë‹¤ìŒ ìƒíƒœë¡œì˜ ì „í™˜ë˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•˜ê³  í›„ì— Storeì—ì„œ ì‹¤í–‰í•´ì•¼í•˜ëŠ” Effectë¥¼ ì„¤ëª…í•˜ëŠ” í”„ë¡œí† ì½œì…ë‹ˆë‹¤.
    ```swift
    protocol ReducerProtocol<State, Action>
    ```
    ì¦‰ ì„ ì–¸ì€ ë‹¹ì—°íˆ State, Actionì„ ê°–ëŠ” í”„ë¡œí† ì½œì…ë‹ˆë‹¤.
    ê·¸ëŸ¼ ì´ì œëŠ” ì´ í”„ë¡œí† ì½œì„ ì±„íƒí•˜ëŠ” êµ¬ì¡°ì²´ë¥¼ í•˜ë‚˜ ë§Œë“¤ë©´ì„œ ì´ ì•ˆì— ëŠ˜ ë¨¹ë˜ê²ƒì²˜ëŸ¼ State, Action, Env ê·¸ë¦¬ê³  reducer ë©”ì„œë“œê¹Œì§€ êµ¬í˜„í•´ì£¼ëŠ”ê²ƒì´ì£ .
    ê³µì‹ë¬¸ì„œ ê¸°ë°˜ìœ¼ë¡œ ì˜ˆì‹œë¥¼ í•œë²ˆ ë³´ê² ìŠµë‹ˆë‹¤!
    ```swift
    struct Feature: ReducerProtocol {
      struct State: Equatable {
        var count = 0
        var numberFactAlert: String?
      }

      enum Action: Equatable {
        case factAlertDismissed
        case decrementButtonTapped
        case incrementButtonTapped
        case numberFactButtonTapped
        case numberFactResponse(TaskResult<String>)
      }

     func reduce(into state: inout State, action: Action) -> Effect<Action, Never> {
        switch action {
          case .factAlertDismissed:
            state.numberFactAlert = nil
            return .none

          case .decrementButtonTapped:
            state.count -= 1
            return .none

          case .incrementButtonTapped:
            state.count += 1
            return .none

          case .numberFactButtonTapped:
            return .task { [count = state.count] in 
              await .numberFactResponse(
                TaskResult { 
                  String(
                    decoding: try await URLSession.shared
                      .data(from: URL(string: "http://numbersapi.com/\(number)/trivia")!).0,
                    using: UTF8.self
                  )
                }
              )
            }

          case let .numberFactResponse(.success(fact)):
            state.numberFactAlert = fact
            return .none

          case .numberFactResponse(.failure):
            state.numberFactAlert = "Could not load a number fact :("
            return .none
          } 
        }
      }
    }
    ```
    ì´ë ‡ê²Œ í”„ë¡œí† ì½œì„ ì±„íƒí•˜ê³  State, Actionì„ ì •ì˜ í•´ì£¼ê³  ìˆì£ .
    ê·¸ ë‹¤ìŒ reducer ìƒìˆ˜ë¥¼ êµ¬í˜„í•˜ë“¯ reduce ë©”ì„œë“œë¥¼ êµ¬í˜„í•´ì¤˜ìš”.
    StateëŠ” ë³€í™”ë¥¼ ì…í˜€ì•¼ë˜ë‹ˆ inout íƒ€ì…ì´ê³  ë°˜í™˜ íƒ€ì…ì€ ë‹¹ì—°íˆ Effect íƒ€ì…ì…ë‹ˆë‹¤.
    ì‹¤ì œ ì´ì œ ì‚¬ìš©ì— ìˆì–´ .run, .taskë¼ë˜ì§€ SwiftConcurrencyì— ë§ì¶° async awaitì„ ì ìš©í•˜ë©´ì„œ ë³€ê²½ëœ ë¶€ë¶„ë“¤ì€ ì–‘ì´ ê½¤ ë˜ê¸°ì— ì´í›„ í¬ìŠ¤íŒ…ì—ì„œ ë‹¤ë¤„ë³´ê² ìŠµë‹ˆë‹¤ğŸ¥²

     ì ê·¸ëŸ¼ ì´ì œ Viewë‹¨ bodyì—ì„œëŠ” ì–´ë–»ê²Œ ë‹¤ë¤„ì¤˜ì•¼í• ì§€ ë³´ê² ìŠµë‹ˆë‹¤.
    ```swift
    struct FeatureView: View {
      let store: StoreOf<Feature>

      var body: some View {
        WithViewStore(self.store, observe: { $0 }) { viewStore in
          VStack {
            HStack {
              Button("âˆ’") { viewStore.send(.decrementButtonTapped) }
              Text("\(viewStore.count)")
              Button("+") { viewStore.send(.incrementButtonTapped) }
            }

            Button("Number fact") { viewStore.send(.numberFactButtonTapped) }
          }
          .alert(
            item: viewStore.binding(
              get: { $0.numberFactAlert.map(FactAlert.init(title:)) },
              send: .factAlertDismissed
            ),
            content: { Alert(title: Text($0.title)) }
          )
        }
      }
    }

    struct FactAlert: Identifiable {
      var title: String
      var id: String { self.title }
    }
    ```
    ì‹¤ì œ Viewì— ì˜¬ë¦´ë•ŒëŠ” ì´ì œ store ìƒìˆ˜ì— StoreOfì˜ íƒ€ì…ìœ¼ë¡œ ìƒì„±í•˜ëŠ”ë° í•´ë‹¹ Coreì—ì„œ ì •ì˜í•˜ê³  ë§Œë“  Featureë¥¼ ì œë„¤ë¦­í•˜ê²Œ ë°›ê²Œ í•´ì¤ë‹ˆë‹¤.
    ê·¸ëŸ°ë‹¤ìŒ WithViewStoreë¡œ body ë‚´ë¶€ì—ì„œ ê°ì‹¸ì„œ ì‚¬ìš©í•˜ëŠ”ê²ƒì€ ê¸°ì¡´ê³¼ ê±°ì˜ ë™ì¼í•©ë‹ˆë‹¤!

    ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ Viewë¥¼ ì˜¬ë ¤ì¤„ main Appì—ì„œëŠ” ì´ë ‡ê²Œ ì‚¬ìš©í•˜ê²Œ ë˜ì£ .
    ```swift
    @main
    struct MyApp: App {
      var body: some Scene {
        FeatureView(
          store: Store(
            initialState: Feature.State(),
            reducer: Feature()
          )
        )
      }
    }
    ```
    ë³´ë©´ stateì—ì„œëŠ” Featureì˜ State ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  reducerëŠ” Feature ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•´ì¤€ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì£ .

    ê·¸ë¦¬ê³  ì•ˆì§šê³  ë„˜ì–´ê°„ê²ƒì´ ìˆëŠ”ë° ê¸°ì¡´ ì„œë²„ í†µì‹  ë° ì™¸ë¶€ ì‚¬ì´ë“œ ì´í™íŠ¸ë¥¼ ì²˜ë¦¬í• ë•ŒëŠ” Environment êµ¬ì¡°ì²´ë¥¼ ì •ì˜í•˜ê³  ì´ë¥¼ reducer ìƒìˆ˜ì—ì„œ ì œë„¤ë¦­í•˜ê²Œ ë°›ì•„ ì‚¬ìš©í–ˆëŠ”ë°ìš”.
    ì´ì œëŠ” ë‹¤ë¦…ë‹ˆë‹¤.
    ```swift
    struct NumberFactClient {
      var fetch: (Int) async throws -> String
    }
    ```
    ì˜ˆë¥¼ë“¤ì–´ ì´ë ‡ê²Œ fetch ê¸°ëŠ¥ì„ ê°–ëŠ” NumberFactClient êµ¬ì¡°ì²´ê°€ ìˆê³  ì˜ì¡´ì„±ì„ ì£¼ì…í•˜ì—¬ ì‚¬ìš©í•´ì•¼ ëœë‹¤ê³  ê°€ì •í•´ë³¼ê»˜ìš”.
    ```swift
    extension NumberFactClient: DependencyKey {
      static let liveValue = Self(
        fetch: { number in
          let (data, _) = try await URLSession.shared
            .data(from: .init(string: "http://numbersapi.com/\(number)")!)
          return String(decoding: data, as: UTF8.self)
        }
      )
    }

    extension DependencyValues {
      var numberFact: NumberFactClient {
        get { self[NumberFactClient.self] }
        set { self[NumberFactClient.self] = newValue }
      }
    }
    ```
    ì´ì œëŠ” DependencyKey í”„ë¡œí† ì½œì„ ì±„íƒí•´ í•´ë‹¹ ìœ í˜•ì„ ì˜ì¡´ì„± ê´€ë¦¬ ì‹œìŠ¤í…œì— ë“±ë¡í•˜ê²Œ ë©ë‹ˆë‹¤.
    ê·¸ëŸ°ë‹¤ìŒ DependencyValuesë¥¼ í™•ì¥í•´ numberFactë¼ëŠ” get set í”„ë¡œí¼í‹°ë¥¼ êµ¬í˜„í•´ì£¼ì£ .
    ì•ìœ¼ë¡  ì´ê±¸ ì‚¬ìš©í•˜ê²Œ ë ê±°ì—ìš”.
    ```swift
    struct Feature: ReducerProtocol {
      struct State { â€¦ }
      enum Action { â€¦ }
      @Dependency(\.numberFact) var numberFact
      â€¦
    }
    ```
    ê·¸ëŸ¼ ì´ë ‡ê²Œ í•„ìš”í•œ Core Featureì—ì„œ @Dependency í”„ë¡œí¼í‹° ë˜í¼ íƒ€ì…ìœ¼ë¡œ numberFactë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    ```swift
    @main
    struct MyApp: App {
      var body: some Scene {
        FeatureView(
          store: Store(
            initialState: Feature.State(),
            reducer: Feature()
          )
        )
      }
    }
    ```
    ê·¸ëŸ¼ ì´ë ‡ê²Œ ì‹¤ì œë¡œ Appë‹¨ì—ì„œë¶€í„° ì˜ì¡´ì„±ì„ ì£¼ì…ë°›ì•„ ë¶€ì—¬í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ”ê²ƒì´ì£ .
    ```swift
    let store = TestStore(
      initialState: Feature.State(),
      reducer: Feature()
    ) {
      $0.numberFact.fetch = { "\($0) is a good number Brent" }
    }
    ```
    ë§Œì•½ í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ êµ¬ì¶•í•œë‹¤ë©´ TestStoreë¥¼ ë§Œë“¤ë•Œ liveí•˜ì§€ ì•Šì€ fetch êµ¬í˜„ì„ ì •ì˜í•´ì£¼ë©´ ë©ë‹ˆë‹¤.
    ì¦‰ ReducerProtocolì„ ì‚¬ìš©í•˜ë©´ì„œ ì¥ì ìœ¼ë¡œ ëŠê»´ì¡Œë˜ í° ë¶€ë¶„ì´ ì˜ì¡´ì„±ì´ í¸ë¦¬í•´ì¡Œë‹¤ëŠ”ê²ƒ ê°™ì•„ìš”â­ï¸
    ì´ì „ì—ëŠ” App ìƒìœ„ë¶€í„° ì­ˆìš± ë°›ì•„ì˜¤ë©° ì˜ì¡´ì„± ì£¼ì…ì„ í•´ì£¼ë‹ˆ ê¹Œë¨¹ì„ë•Œë„ ìˆê³  ì¶”ê°€ë˜ë©´ ë§ì€ ëìŠ¤ì˜ ì½”ë“œ ìˆ˜ì •ì´ ì´ë¤„ì¡Œì–´ì•¼í•˜ëŠ”ë° ì´ì œëŠ” ê·¸ëŸ° ì‘ì—…ì´ ë¶ˆí•„ìš”í•˜ì£ ğŸ‘

    #### ë§ˆë¬´ë¦¬

    ì´ë ‡ê²Œ ì•„ì£¼ì•„ì£¼ì•„ì£¼ ê°„ë‹¨í•˜ê²Œ ReducerProtocolì˜ ë¦¬ë“œë¯¸ ì •ë„ë¡œë§Œ ì–´ë–¤ê²Œ ë‚˜ì˜¨ê±´ì§€ ì•Œì•„ë³´ê¸´ë§Œ í–ˆì–´ìš”.
    ì•„ì§ ê¹Šì´ìˆê³  ì‹¤ì „ ì‘ìš©ìœ¼ë¡œ í•˜ê¸°ì—ëŠ” í•™ìŠµì´ ë¯¸ìƒì´ë¼!
    ì´ì œ ìµœì‹ ë²„ì „ì„ ê¸°ì¤€ìœ¼ë¡œ ì¡°ê¸ˆì”© ë¸”ë¡œê¹… í•´ë‚˜ê°€ê² ìŠµë‹ˆë‹¤ğŸ™Œ

    #### [ì°¸ê³  ìë£Œ]
    https://green1229.tistory.com/325   
    https://pointfreeco.github.io/swift-composable-architecture/0.41.0/documentation/composablearchitecture/reducerprotocol/
    https://www.pointfree.co/blog/posts/81-announcing-the-reducer-protocol
    www.pointfree.co
    https://github.com/pointfreeco/swift-composable-architecture/tree/0.50.1